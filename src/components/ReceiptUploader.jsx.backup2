import React, { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Upload, Plus, Trash2, DollarSign, Calendar, Store, Tag, CreditCard, List, X, Camera, CheckCircle, XCircle, PlusCircle, Save, Edit, Mail, LineChart, Lock, Loader2, MinusCircle, ChevronDown, ChevronUp } from 'lucide-react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { useToast } from "@/components/ui/use-toast";
import { db } from '@/firebase'; // Import your Firebase db instance
import { collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, updateDoc } from "firebase/firestore"; // Import Firestore functions
import {
  fetchExchangeRates,
  convertToBaseCurrency,
  initializeExchangeRates
} from '@/utils/currencyUtils';
import { loadSettings, formatDate } from '@/utils/settingsUtils'; // Corrected import for formatDate
import { useAuth } from '@/contexts/AuthContext';
import { useLoading } from '@/contexts/LoadingContext';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "./ui/dialog";
import {
  ScrollArea,
} from "./ui/scroll-area";
import { Doughnut, Line, Pie, Bar } from 'react-chartjs-2';
import { Chart, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, TimeScale, Filler, BarElement } from 'chart.js';
import { CircularProgressbarWithChildren, buildStyles } from 'react-circular-progressbar';
import 'react-circular-progressbar/dist/styles.css';
Chart.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, TimeScale, Filler, BarElement);

// Define supported currencies
const SUPPORTED_CURRENCIES = [
  { code: 'EUR', symbol: 'â‚¬', name: 'Euro' },
  { code: 'USD', symbol: '$', name: 'US Dollar' },
  { code: 'GBP', symbol: 'Â£', name: 'British Pound' },
  { code: 'JPY', symbol: 'Â¥', name: 'Japanese Yen' },
  { code: 'CAD', symbol: 'C$', name: 'Canadian Dollar' },
  { code: 'AUD', symbol: 'A$', name: 'Australian Dollar' },
  { code: 'CHF', symbol: 'Fr', name: 'Swiss Franc' },
  { code: 'CNY', symbol: 'Â¥', name: 'Chinese Yuan' },
  { code: 'PLN', symbol: 'zÅ‚', name: 'Polish ZÅ‚oty' }
];

// Add currency conversion rates (you would typically fetch these from an API)
const CURRENCY_RATES = {
  EUR: 1,
  USD: 1.08,
  GBP: 0.86,
  JPY: 161.62,
  CAD: 1.47,
  AUD: 1.65,
  CHF: 0.95,
  CNY: 7.83,
  PLN: 4.32
};

// Helper function to normalize date format
const normalizeDate = (input) => {
  if (!input) return '';
  
  // If input is already in YYYY-MM-DD format, return as is
  if (/^\d{4}-\d{2}-\d{2}$/.test(input)) {
    return input;
  }
  
  try {
    // Try to parse the date
    const date = new Date(input);
    if (isNaN(date.getTime())) {
      return '';
    }
    
    // Format as YYYY-MM-DD
    return date.toISOString().split('T')[0];
  } catch (error) {
    console.error('Date normalization error:', error);
    return '';
  }
};

// Add at the top-level of the file (outside the component):
const missingMessages = {
  merchant: [
    "Whoops! We need to know where you spent your hard-earned cash. Please enter the merchant name! ðŸª",
    "The merchant is a mystery... for now. Fill it in! ðŸ•µï¸â€â™‚ï¸",
    "No merchant? No memory! Please tell us where you shopped. ðŸ›’"
  ],
  total: [
    "How much did you spend? The universe (and your budget) needs to know! ðŸ’¸",
    "Total amount missing! Your wallet is confused. ðŸ¤”",
    "No total, no tally! Please enter the amount. ðŸ§®"
  ],
  date: [
    "When did this happen? Time travel is hard without a date! â³",
    "Date missing! Was it yesterday, today, or in a galaxy far, far away? ðŸŒŒ",
    "No date, no story! Please pick a day. ðŸ“…"
  ],
  items: [
    "What did you buy? At least one item, please! ðŸ›ï¸",
    "No items? No fun! Add something to your receipt. ðŸŽ",
    "Your receipt is hungry for items. Feed it! ðŸ”"
  ]
};

const getFunnyMissingMessage = (missing) => {
  if (missing.length === 1) {
    const key = missing[0];
    const options = missingMessages[key];
    return options[Math.floor(Math.random() * options.length)];
  } else if (missing.length > 1) {
    // Combine messages for multiple missing fields
    return (
      missing.map(key => {
        const options = missingMessages[key];
        return options[Math.floor(Math.random() * options.length)];
      }).join(' ')
    );
  }
  return "Something's missing, but we're not sure what!";
};

// Add at the top of the component:
const categoryColors = {
  Groceries: 'border-green-400',
  Dining: 'border-pink-400',
  Transportation: 'border-yellow-400',
  Shopping: 'border-purple-400',
  Bills: 'border-blue-400',
  Entertainment: 'border-indigo-400',
  Health: 'border-emerald-400',
  Other: 'border-gray-400',
  Uncategorized: 'border-blue-500',
};
const getCategoryColor = (cat) => categoryColors[cat] || categoryColors['Uncategorized'];

export default function ReceiptUploader({ className, showOnly, onTabChange }) {
  const { toast } = useToast();
  const authContext = useAuth();
  const user = authContext ? authContext.user : null;
  const { isLoading, setIsLoading } = useLoading();
  const [file, setFile] = useState(null);
  const [amount, setAmount] = useState('');
  const [merchant, setMerchant] = useState('');
  const [date, setDate] = useState('');
  const [category, setCategory] = useState('');
  const [subtotal, setSubtotal] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('');
  const [items, setItems] = useState([]);
  const [receipts, setReceipts] = useState([]);
  const [totalExpenses, setTotalExpenses] = useState(0);
  const [categoryTotals, setCategoryTotals] = useState({});
  const [isOcrProcessing, setIsOcrProcessing] = useState(false);
  const [ocrError, setOcrError] = useState(null);
  const [isFirestoreLoading, setIsFirestoreLoading] = useState(true);
  const [firestoreError, setFirestoreError] = useState(null);
  const [formErrors, setFormErrors] = useState({});
  const [editingReceipt, setEditingReceipt] = useState(null);
  const [editForm, setEditForm] = useState({
    merchant: '',
    amount: '',
    date: '',
    category: '',
    subtotal: '',
    payment_method: '',
    currency: 'EUR',
    items: []
  });
  const [newItem, setNewItem] = useState({ name: '', price: '' });
  const [editingItemIndex, setEditingItemIndex] = useState(null);
  const [isCameraOpen, setIsCameraOpen] = useState(false);
  const [isCameraReady, setIsCameraReady] = useState(false);
  let _videoElement = null; // Mutable variable to hold the video DOM element
  const videoRef = (node) => {
    if (node) {
      _videoElement = node;
      // Only start camera if modal is open and camera isn't already running
      if (isCameraOpen && !isCameraReady) {
        console.log('Video element assigned to ref, and camera modal is open. Calling startCamera.');
        startCamera();
      }
    } else {
      _videoElement = null;
      console.log('Video element detached from ref.');
    }
  };
  const canvasRef = useRef(null);
  const [showFullScreenPreview, setShowFullScreenPreview] = useState(false);
  const [previewImageSrc, setPreviewImageSrc] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [currentStep, setCurrentStep] = useState('upload_options'); // Changed initial state

  // New states for the "Edit Receipt Form" section's item management
  const [currentReceipt, setCurrentReceipt] = useState(null); // Holds the receipt being edited
  const [currentNewItem, setCurrentNewItem] = useState({ name: '', price: '' }); // For adding/editing items in the edit form
  const [currentEditingItemIndex, setCurrentEditingItemIndex] = useState(null); // Index for editing items in the edit form
  const [expandedReceiptId, setExpandedReceiptId] = useState(null); // New state to manage expanded receipt
  const [expandedInCategoryModalId, setExpandedInCategoryModalId] = useState(null);
  const [returnToCategory, setReturnToCategory] = useState(null);

  // State for form data
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0], // Set today's date as default
    merchant: '',
    total: '',
    tax: '',
    subtotal: '',
    paymentMethod: '',
    currency: 'EUR',
    items: [],
    category: ''
  });

  // State for UI
  const [isBusy, setIsBusy] = useState(false);
  const [message, setMessage] = useState(null);
  const [currentFunnyMessage, setCurrentFunnyMessage] = useState('');

  // Combine isLoading and isFirestoreLoading for a global busy state
  const isBusyGlobal = isFirestoreLoading;

  // Array of funny loading messages
  const funnyMessages = [
    "Teaching receipts to read... ðŸ“š",
    "Counting pixels and dollars... ðŸ’°",
    "Wrangling numbers into submission... ðŸ¤ ",
    "Decoding receipt hieroglyphics... ðŸ”",
    "Making receipts talk... ðŸ—£ï¸",
    "Converting paper to pixels... ðŸ“„âž¡ï¸ðŸ’»",
    "Teaching AI to read receipts... ðŸ¤–",
    "Calculating the meaning of life, the universe, and your receipt... ðŸŒŒ",
    "Hold tight, magic is happening! âœ¨",
    "Scanning for hidden discounts... ðŸ”Ž",
    "Teaching receipts to dance... ðŸ’ƒ",
    "Brewing coffee for the receipt scanner... â˜•",
    "Polishing the pixels... âœ¨",
    "Feeding the receipt scanner... ðŸ•",
    "Teaching receipts to do yoga... ðŸ§˜â€â™‚ï¸",
    "Counting all the zeros... 0ï¸âƒ£",
    "Making the receipt scanner happy... ðŸ˜Š",
    "Teaching receipts to sing... ðŸŽµ",
    "Polishing the digital lens... ðŸ”",
    "Feeding the AI some numbers... ðŸ¤–"
  ];

  const getRandomFunnyMessage = () => {
    return funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
  };

  const categories = [
    "Groceries",
    "Dining",
    "Transportation",
    "Shopping",
    "Bills",
    "Entertainment",
    "Health",
    "Other"
  ];

  const receiptsCollectionRef = collection(db, "receipts");

  const fetchReceipts = async () => {
    if (!user) {
      console.log("fetchReceipts: User not authenticated, skipping fetch.");
      return;
    }
    console.log("fetchReceipts: Current user:", user);
    setIsFirestoreLoading(true);
    setFirestoreError(null);
    try {
      const data = await getDocs(receiptsCollectionRef);
      const receiptsList = data.docs.map((doc) => ({ ...doc.data(), id: doc.id }));
      console.log("fetchReceipts: All fetched receipts (before filter):", receiptsList);
      // Only show receipts for the current user
      const userReceipts = receiptsList.filter(r => {
        const isMatch = r.userId === user.uid; // Corrected field name from user_id to userId
        console.log(`Receipt ID: ${r.id}, Receipt userId: ${r.userId}, Current User UID: ${user.uid}, Match: ${isMatch}`);
        return isMatch;
      });
      console.log("fetchReceipts: Filtered user receipts:", userReceipts);
      // Sort receipts by last updated timestamp (or created_at if not updated)
      const sortedReceipts = userReceipts.sort((a, b) => {
        const dateA = (a.updated_at?.toDate?.() || a.createdAt?.toDate?.() || new Date(0));
        const dateB = (b.updated_at?.toDate?.() || b.createdAt?.toDate?.() || new Date(0));
        return dateB - dateA; // Sort in descending order (newest first)
      });
      setReceipts(sortedReceipts);
    } catch (error) {
      console.error("Error fetching receipts:", error);
      setFirestoreError("Failed to load receipts. Please try again.");
    } finally {
      setIsFirestoreLoading(false);
    }
  };

  useEffect(() => {
    fetchReceipts();
  }, []);

  useEffect(() => {
    // Calculate total expenses for current month only
    const today = new Date();
    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const currentMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
    
    // Helper to normalize date for comparison
    const normalizeToLocalMidnight = (d) => {
      if (!d) return null;
      if (typeof d.toDate === 'function') { d = d.toDate(); } // Handle Firestore Timestamps
      if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
        const [year, month, day] = d.split('-').map(Number);
        return new Date(year, month - 1, day);
      }
      const date = new Date(d);
      if (isNaN(date)) return null;
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    };
    
    // Filter receipts for current month
    const currentMonthReceipts = receipts.filter(receipt => {
      const receiptDate = normalizeToLocalMidnight(receipt.transactionDate || receipt.date || receipt.createdAt);
      return receiptDate && receiptDate >= currentMonthStart && receiptDate <= currentMonthEnd;
    });
    
    const total = currentMonthReceipts.reduce((sum, receipt) => sum + (parseFloat(receipt.total) || 0), 0);
    setTotalExpenses(total);

    // Calculate category totals for current month only
    const categorySums = currentMonthReceipts.reduce((acc, receipt) => {
      const cat = receipt.category || 'Uncategorized';
      const amount = parseFloat(receipt.total) || 0;
      acc[cat] = (acc[cat] || 0) + amount;
      return acc;
    }, {});
    setCategoryTotals(categorySums);
  }, [receipts]);

  useEffect(() => {
    // Compute isBusy directly from its state dependencies inside the effect
    const isComponentBusy = isLoading || isFirestoreLoading;
    if (isComponentBusy) {
      const randomIndex = Math.floor(Math.random() * funnyMessages.length);
      setCurrentFunnyMessage(funnyMessages[randomIndex]);
    } else {
      setCurrentFunnyMessage(''); // Clear message when not busy
    }
  }, [isLoading, isFirestoreLoading]); // Depend on the raw state variables

  const [convertedAmount, setConvertedAmount] = useState(null);
  const [convertedSubtotal, setConvertedSubtotal] = useState(null);
  const [convertedItems, setConvertedItems] = useState([]);
  const [exchangeRates, setExchangeRates] = useState(null);

  // Initialize exchange rates on component mount
  useEffect(() => {
    initializeExchangeRates().then(rates => {
      setExchangeRates(rates);
    });
  }, []);

  // Update exchange rates periodically
  useEffect(() => {
    const interval = setInterval(async () => {
      try {
        const rates = await fetchExchangeRates();
        setExchangeRates(rates);
      } catch (error) {
        console.error('Failed to update exchange rates:', error);
      }
    }, 3600000); // Update every hour

    return () => clearInterval(interval);
  }, []);

  const fileInputRef = useRef(null); // Ref for the file input element

  // Correct and robust settings initialization
  const [settings, setSettings] = useState(() => {
    try {
      const savedSettings = loadSettings();
      // Ensure savedSettings is an object, or use a default if it's null/undefined/invalid JSON
      return savedSettings || {
        dateFormat: 'YYYY-MM-DD',
        baseCurrency: 'EUR',
        showOriginalAmounts: true,
        showConvertedAmounts: true
      };
    } catch (error) {
      console.error('Error loading settings from localStorage:', error);
      // Fallback to default settings if there's any error in loading/parsing
      return {
        dateFormat: 'YYYY-MM-DD',
        baseCurrency: 'EUR',
        showOriginalAmounts: true,
        showConvertedAmounts: true
      };
    }
  });

  // Update settings when they change (e.g., from other components via localStorage event)
  useEffect(() => {
    const handleStorageChange = () => {
      try {
        const newSettings = loadSettings();
        if (newSettings) {
          setSettings(newSettings);
        }
      } catch (error) {
        console.error('Error updating settings from storage event:', error);
      }
    };

    const handleSettingsUpdated = (e) => {
      setSettings(e.detail);
    };

    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('settings-updated', handleSettingsUpdated);
    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('settings-updated', handleSettingsUpdated);
    };
  }, []);

  console.log('ReceiptUploader component - Current settings state:', settings);

  // Helper function to format date safely
  const formatDateSafely = (dateString, formatOverride = null) => {
    try {
      // Ensure settings and dateFormat are available before calling formatDate
      // Provide a fallback settings object if the component's settings state is not yet ready
      const currentSettings = settings || { dateFormat: 'YYYY-MM-DD', baseCurrency: 'EUR' }; // Minimal default for formatting
      if (!dateString) return '';

      // Use formatOverride if provided, otherwise use currentSettings.dateFormat
      const formatToUse = formatOverride || currentSettings.dateFormat;
      return formatDate(dateString, { ...currentSettings, dateFormat: formatToUse });
    } catch (error) {
      console.error('Error formatting date:', error);
      return dateString || '';
    }
  };

  const convertToEUR = (amount, fromCurrency) => {
    if (fromCurrency === 'EUR') return parseFloat(amount);
    if (!exchangeRates || !exchangeRates[fromCurrency] || !amount) return parseFloat(amount); // Return original if no rate
    return (parseFloat(amount) / exchangeRates[fromCurrency]).toFixed(2);
  };

  const handleDeleteReceipt = async (id) => {
    if (!user) {
      toast({
        title: "Authentication Required",
        description: "Please sign in to delete receipts.",
        variant: "destructive",
      });
      return;
    }
    try {
      await deleteDoc(doc(db, "receipts", id));
      setReceipts(receipts.filter((receipt) => receipt.id !== id));
      toast({
        title: "Receipt Deleted! ðŸ—‘ï¸",
        description: "The receipt has been successfully removed.",
      });
      await fetchReceipts();
    } catch (error) {
      console.error("Error deleting receipt:", error);
      toast({
        title: "Error Deleting Receipt ðŸ˜¥",
        description: `There was an issue deleting the receipt: ${error.message}`,
        variant: "destructive",
      });
    }
  };

  const handleImageChange = (e) => {
    const selectedFile = e.target.files[0];
    if (selectedFile) {
      setFile(selectedFile);
      // Create a preview URL for the selected file
      const reader = new FileReader();
      reader.onload = (event) => {
        setPreviewImageSrc(event.target.result);
        setShowFullScreenPreview(true);
      };
      reader.readAsDataURL(selectedFile);
      // Clear the input value to allow re-uploading the same file
      e.target.value = null; 
    }
  };

  // Refactor: Use a single handler for all top-level form input changes
  const handleFormInputChange = (e) => {
    const { name, value } = e.target;
    const targetStateSetter = editingReceipt ? setEditForm : setFormData;

    targetStateSetter(prev => {
      let updatedData = { ...prev };
      if (name === "total" || name === "subtotal" || name === "tax") {
        // Allow empty string or numbers with up to 2 decimal places
        if (value === '' || /^-?[0-9]*\.?[0-9]{0,2}$/.test(value.replace(',', '.'))) {
          updatedData[name] = value.replace(',', '.');
        }
      } else if (name === "date") {
        updatedData[name] = normalizeDate(value);
      } else {
        updatedData[name] = value;
      }
      return updatedData;
    });

    // If editing, also update currentReceipt to reflect changes live in the modal for item management
    if (editingReceipt) {
      setCurrentReceipt(prev => {
        let updatedReceipt = { ...prev };
        // Special handling for numerical fields to ensure they are parsed correctly for currentReceipt
        updatedReceipt[name] = (name === "total" || name === "subtotal" || name === "tax") ? (value === '' ? '' : parseFloat(value.replace(',', '.'))) : value;
        return updatedReceipt;
      });
    }
  };

  // Refactor: Use a single handler for all item input changes within the form
  const handleItemInputChange = (e, index, field) => {
    const { value } = e.target;
    const targetStateSetter = editingReceipt ? setEditForm : setFormData;

    targetStateSetter(prev => {
      const updatedItems = [...(prev.items || [])];
      updatedItems[index] = {
        ...updatedItems[index],
        [field]: (field === 'price') ? (value === '' ? '' : parseFloat(value.replace(',', '.')).toFixed(2)) : value
      };
      return { ...prev, items: updatedItems };
    });

    // If editing, also update currentReceipt items to reflect changes live in the modal
    if (editingReceipt) {
      setCurrentReceipt(prev => {
        const updatedItems = [...(prev.items || [])];
        updatedItems[index] = {
          ...updatedItems[index],
          [field]: (field === 'price') ? (value === '' ? '' : parseFloat(value.replace(',', '.')).toFixed(2)) : value
        };
        return { ...prev, items: updatedItems };
      });
    }
  };

  // Update the `handleSaveReceipt` for new receipts
  const handleSaveReceiptSubmit = async () => {
    if (!user) {
      toast({
        title: "Authentication Required",
        description: "Please sign in to save receipts.",
        variant: "destructive",
      });
      return;
    }

    setIsBusy(true);
    setFormErrors({}); // Clear previous errors

    // Use the correct form state for validation and saving
    const activeFormData = editingReceipt ? editForm : formData;

    // Basic validation for required fields
    const missingFields = [];
    if (!activeFormData.merchant) missingFields.push('merchant');
    if (!activeFormData.total) missingFields.push('total');
    if (!activeFormData.date) missingFields.push('date');
    if (!activeFormData.items || activeFormData.items.length === 0) missingFields.push('items');

    if (missingFields.length > 0) {
      setFormErrors({
        merchant: !activeFormData.merchant ? 'Merchant is required.' : '',
        date: !activeFormData.date ? 'Date is required.' : '',
        total: !activeFormData.total ? 'Total amount is required.' : '',
        items: !activeFormData.items || activeFormData.items.length === 0 ? 'At least one item is required.' : ''
      });
      toast({
        title: "Missing Information",
        description: getFunnyMissingMessage(missingFields),
        variant: "destructive",
      });
      setIsBusy(false);
      return;
    }

    // Ensure all items have a name and a valid price
    const cleanedItems = (activeFormData.items || []).filter(item => item.name && !isNaN(parseFloat(item.price)) && item.price !== '').map(item => ({
      name: item.name,
      price: parseFloat(item.price)
    }));

    if (cleanedItems.length === 0) {
      setFormErrors({
        items: 'Please ensure all items have a name and a valid price.'
      });
      toast({
        title: "Invalid Items",
        description: "Please ensure all items have a name and a valid price.",
        variant: "destructive",
      });
      setIsBusy(false);
      return;
    }

    // Calculate tax if not manually entered (total - subtotal)
    let calculatedTax = parseFloat(activeFormData.tax) || 0;
    if (!activeFormData.tax && activeFormData.total && activeFormData.subtotal) {
      calculatedTax = parseFloat(activeFormData.total) - parseFloat(activeFormData.subtotal);
      if (isNaN(calculatedTax) || calculatedTax < 0) calculatedTax = 0; // Ensure non-negative tax
    }

    const receiptData = {
      userId: user.uid,
      merchant: activeFormData.merchant,
      date: serverTimestamp(), // Use server timestamp for consistency
      transactionDate: activeFormData.date, // Keep original date string for display
      total: parseFloat(activeFormData.total),
      subtotal: parseFloat(activeFormData.subtotal),
      tax: calculatedTax,
      paymentMethod: activeFormData.paymentMethod || 'Other',
      currency: activeFormData.currency,
      items: cleanedItems,
      imageUrl: activeFormData.imageUrl || '',
      category: activeFormData.category || 'Uncategorized', // Ensure category is never undefined
      createdAt: serverTimestamp()
    };

    console.log("Receipt data being sent to Firestore:", receiptData);

    try {
      if (editingReceipt) {
        // Update existing receipt
        await updateDoc(doc(db, "receipts", editingReceipt.id), receiptData);
        toast({
          title: "Receipt Updated! ðŸš€",
          description: "Your receipt has been successfully updated.",
        });
      } else {
        // Create new receipt
      await addDoc(collection(db, "receipts"), receiptData);
      toast({
        title: "Receipt Saved! ðŸŽ‰",
        description: "Your expense has been successfully recorded.",
      });
      }
      // Reset form and close modal
      setFormData({ // Ensure formData is reset for next new entry
        date: new Date().toISOString().split('T')[0],
        merchant: '',
        total: '',
        tax: '',
        subtotal: '',
        paymentMethod: '',
        currency: 'EUR',
        items: [],
        category: ''
      });
      setNewItem({ name: '', price: '' });
      setEditingReceipt(null);
      setIsEditing(false);
      setFile(null);
      setPreviewImageSrc(null);
      setCurrentStep('upload_options');
      await fetchReceipts();
      
      // Navigate to expenses tab to show the updated financial overview
      if (onTabChange) {
        onTabChange('expenses');
      }
    } catch (error) {
      console.error("Error saving receipt:", error);
      toast({
        title: editingReceipt ? "Error Updating Receipt ðŸ˜¥" : "Error Saving Receipt ðŸ˜¥",
        description: `There was an issue saving your receipt: ${error.message}`,
        variant: "destructive",
      });
    } finally {
      setIsBusy(false);
    }
  };

  const handleCloseReceiptForm = () => {
    if (returnToCategory) {
      // If we came from a category modal, return to it
      setSelectedCategory(returnToCategory);
      setModalOpen(true);
      setReturnToCategory(null);
      } else {
      // Otherwise, go back to the main view
      setCurrentStep('upload_options');
    }
    // Reset all form states
    setEditingReceipt(null);
    setIsEditing(false);
    resetFormData();
    setFile(null);
    setPreviewImageSrc(null);
  };

  // Update the `handleEditSave` for existing receipts
  const handleEditSaveSubmit = async (event) => {
    event.preventDefault(); // Prevent default form submission

    if (!user) {
      toast({
        title: "Authentication Required",
        description: "Please sign in to save changes.",
        variant: "destructive",
      });
      return;
    }

    if (!editingReceipt) {
      toast({
        title: "Error",
        description: "No receipt selected for editing.",
        variant: "destructive",
      });
      return;
    }

    // Validate essential fields for edit form
    if (!editForm.merchant || !editForm.date || !editForm.total) { // Use editForm.total here
      toast({
        title: "Missing Information",
        description: "Please fill in all required fields: Merchant, Total, and Date.",
        variant: "destructive",
      });
      return;
    }

    // Validate items in edit form
    const hasIncompleteItem = editForm.items.some(item => (item.name && !item.price) || (!item.name && item.price));
    if (hasIncompleteItem) {
      toast({
        title: "Incomplete Item",
        description: "Please ensure all items have both a name and a price, or remove incomplete items.",
        variant: "destructive",
      });
      return;
    }

    setIsBusy(true);

    try {
      const parsedTotal = parseFloat(editForm.total); // Use editForm.total
      const parsedSubtotal = parseFloat(editForm.subtotal);

      if (isNaN(parsedTotal) || parsedTotal <= 0) {
        toast({
          title: "Invalid Total Amount",
          description: "Please enter a valid positive number for the total amount.",
          variant: "destructive",
        });
        return;
      }
      if (editForm.subtotal && (isNaN(parsedSubtotal) || parsedSubtotal < 0)) {
        toast({
          title: "Invalid Subtotal",
          description: "Please enter a valid non-negative number for the subtotal.",
          variant: "destructive",
        });
        return;
      }

      // Calculate tax if not provided
      let taxAmount = parseFloat(editForm.tax); // Use editForm.tax
      if (isNaN(taxAmount) || editForm.tax === '') {
        taxAmount = (parsedTotal - (parsedSubtotal || parsedTotal)).toFixed(2); // If subtotal exists, tax is total - subtotal, else 0
      } else {
        taxAmount = taxAmount.toFixed(2);
      }

      const updatedReceiptData = {
        userId: user.uid, // Use userId for consistency
        merchant: editForm.merchant,
        total: parsedTotal, // Store as number
        subtotal: parsedSubtotal ? parsedSubtotal : undefined, // Store as number
        tax: parseFloat(taxAmount), // Store as number
        transactionDate: editForm.date, // Use transactionDate for consistency
        category: editForm.category,
        paymentMethod: editForm.payment_method,
        currency: editForm.currency || editingReceipt.currency || settings.baseCurrency,
        items: editForm.items.map(item => ({
          name: item.name,
          price: parseFloat(item.price) // Store as number
        })),
        updated_at: serverTimestamp()
      };

      await updateDoc(doc(db, "receipts", editingReceipt.id), updatedReceiptData);
      toast({
        title: "Receipt Updated! ðŸš€",
        description: "Your receipt has been successfully updated.",
      });

      // Reset editing state and close modal
      setEditingReceipt(null);
      setIsEditing(false);
      setCurrentStep('upload_options');
      await fetchReceipts();
      
      // Navigate to expenses tab to show the updated financial overview
      if (onTabChange) {
        onTabChange('expenses');
      }
    } catch (error) {
      console.error("Error updating receipt:", error);
      toast({
        title: "Error Updating Receipt ðŸ˜¥",
        description: `There was an issue updating your receipt: ${error.message}`,
        variant: "destructive",
      });
    } finally {
      setIsBusy(false);
    }
  };

  const handleEditCancel = () => {
    setEditingReceipt(null);
    setIsEditing(false);
    // Ensure editForm is reset when cancelling edit
    setEditForm({
      merchant: '',
      amount: '',
      date: '',
      category: '',
      subtotal: '',
      payment_method: '',
      currency: 'EUR',
      items: []
    });
    setCurrentNewItem({ name: '', price: '' });
    setCurrentEditingItemIndex(null);
  };

  // Add Item to manual entry form
  const handleAddItem = () => {
    if (!newItem.name.trim() && !newItem.price.trim()) {
      return;
    }
    if (!newItem.name.trim() || !newItem.price.trim()) {
      toast({
        title: "Incomplete Item",
        description: "Please provide both item name and price.",
        variant: "destructive",
      });
      return;
    }

    const priceNum = parseFloat(newItem.price.replace(',', '.'));
    if (isNaN(priceNum)) {
      toast({
        title: "Invalid Price",
        description: "Item price must be a valid number.",
        variant: "destructive",
      });
      return;
    }

    setFormData(prev => ({
      ...prev,
      items: [...(prev.items || []), { name: newItem.name.trim(), price: priceNum.toFixed(2) }]
    }));
    setNewItem({ name: '', price: '' });
  };

  // Add Item to edit form
  const handleEditItemAdd = () => {
    if (!currentNewItem.name.trim() || !currentNewItem.price.trim()) {
      toast({
        title: "Incomplete Item",
        description: "Please provide both item name and price for the new item.",
        variant: "destructive",
      });
      return;
    }
    const priceNum = parseFloat(currentNewItem.price.replace(',', '.'));
    if (isNaN(priceNum)) {
      toast({
        title: "Invalid Price",
        description: "New item price must be a valid number.",
        variant: "destructive",
      });
      return;
    }

    setEditForm(prev => ({
      ...prev,
      items: [...(prev.items || []), { name: currentNewItem.name.trim(), price: priceNum.toFixed(2) }]
    }));
    setCurrentReceipt(prev => ({
      ...prev,
      items: [...(prev.items || []), { name: currentNewItem.name.trim(), price: priceNum.toFixed(2) }]
    }));
    setCurrentNewItem({ name: '', price: '' });
  };

  // Helper for adding new item fields dynamically
  const handleAddItemField = (insertIndex) => {
    const targetStateSetter = editingReceipt ? setEditForm : setFormData;
    targetStateSetter(prevData => {
      const newItems = [...(prevData.items || [])];
      newItems.splice(insertIndex, 0, { name: '', price: '' });
      return { ...prevData, items: newItems };
    });
    if (editingReceipt) {
    setCurrentReceipt(prev => {
      const newItems = [...(prev.items || [])];
      newItems.splice(insertIndex, 0, { name: '', price: '' });
      return { ...prev, items: newItems };
    });
    }
  };

  // Helper for removing item fields dynamically
  const handleRemoveItemField = (removeIndex) => {
    const targetStateSetter = editingReceipt ? setEditForm : setFormData;
    targetStateSetter(prevData => {
      if ((prevData.items || []).length === 1 && (!prevData.items[0].name && !prevData.items[0].price)) {
        return prevData; // Prevent removing the last empty item if it's the only one
      }
      if ((prevData.items || []).length > 0) {
        const newItems = (prevData.items || []).filter((_, i) => i !== removeIndex);
        return { ...prevData, items: newItems };
      }
      return prevData; // Do nothing if trying to remove from empty list
    });
    if (editingReceipt) {
    setCurrentReceipt(prev => {
        if ((prev.items || []).length === 1 && (!prev.items[0].name && !prev.items[0].price)) {
        return prev;
      }
        if ((prev.items || []).length > 0) {
          const newItems = (prev.items || []).filter((_, i) => i !== removeIndex);
        return { ...prev, items: newItems };
      }
      return prev;
    });
    }
  };

  // Determine which form state to use based on editingReceipt
  const activeFormData = editingReceipt ? editForm : formData;

  // Update the receipt card rendering
  const renderReceiptCard = (receipt) => {
    const isExpanded = expandedReceiptId === receipt.id;
    const amount = parseFloat(receipt.total);
    const isNegative = isNaN(amount) || amount < 0;
    const catColor = getCategoryColor(receipt.category);
    const isSwiped = swipedId === receipt.id;
    const { progress, dir } = getSwipeProgress(receipt.id);
    return (
      <div
        className="relative w-full overflow-x-hidden" // Add overflow-x-hidden here
        style={{ touchAction: 'pan-y' }} // Allow vertical scrolling, prevent horizontal pan
        onTouchStart={e => handleTouchStart(receipt.id, e)}
        onTouchMove={e => handleTouchMove(receipt.id, e)}
        onTouchEnd={() => handleTouchEnd(receipt.id)}
      >
        {/* Swipe backgrounds with animated icon */}
        <div
          className={`absolute inset-0 z-0 flex items-center transition-all duration-200 ${dir === 'left' ? 'justify-end pr-8' : dir === 'right' ? 'justify-start pl-8' : ''}`}
          style={{
            background: dir === 'left'
              ? `rgba(220,38,38,${progress * 0.8})` // red-600
              : dir === 'right'
              ? `rgba(37,99,235,${progress * 0.8})` // blue-600
              : 'transparent',
            borderRadius: '1rem',
            pointerEvents: 'none',
          }}
        >
          {dir === 'left' && (
            <Trash2
              className="h-7 w-7 text-white"
              style={{
                opacity: progress,
                transform: `scale(${0.8 + 0.4 * progress})`,
                transition: 'all 0.2s',
              }}
            />
          )}
          {dir === 'right' && (
            <Edit
              className="h-7 w-7 text-white"
              style={{
                opacity: progress,
                transform: `scale(${0.8 + 0.4 * progress})`,
                transition: 'all 0.2s',
              }}
            />
          )}
        </div>
        <Card
          id={`receipt-card-${receipt.id}`}
          key={receipt.id || receipt._id || receipt.date+receipt.merchant+receipt.total}
          style={{
            minHeight: 96,
            transform: `translateX(${swipeOffset[receipt.id] || 0}px)`, // Only Card moves
            transition: swipeOffset[receipt.id] ? 'none' : 'transform 0.5s cubic-bezier(0.22,1,0.36,1)', // springy
          }}
          className={`relative bg-slate-800/90 p-5 pl-4 rounded-2xl shadow-xl text-white border border-blue-900/30 border-l-4 ${catColor} transition-all duration-300 ease-in-out animate-fade-in-up ${isExpanded ? 'ring-2 ring-blue-500/50 scale-[1.01] shadow-2xl' : 'hover:shadow-2xl hover:-translate-y-1 active:scale-[0.98]'}`}
          onClick={() => setExpandedReceiptId(isExpanded ? null : receipt.id)}
          aria-label={`Receipt for ${receipt.merchant}`}
        >
          <div className="flex items-center justify-between gap-2 w-full">
            <div className="flex flex-col flex-1 min-w-0">
              <div className="flex items-center gap-2 min-w-0">
                <span className="text-lg font-extrabold text-blue-200 truncate max-w-[120px] md:max-w-[200px] tracking-tight" title={receipt.merchant}>{receipt.merchant}</span>
                <span className="text-xs text-blue-200/80 font-medium whitespace-nowrap">{formatDateSafely(receipt.transactionDate, 'DD MMM')}</span>
              </div>
              <div className="flex items-baseline gap-1 mt-1">
                <span className={`text-2xl font-extrabold ${isNegative ? 'text-red-400' : 'text-blue-100'}`}>{isNegative ? '0.00' : amount.toFixed(2)}</span>
                <span className="text-sm text-blue-200/80 ml-1">{receipt.currency}</span>
              </div>
            </div>
            <div className="flex flex-col gap-2 items-end ml-2">
          <Button
                onClick={e => { e.stopPropagation(); handleEditClick(receipt); }}
            variant="ghost"
            size="icon"
                className="text-blue-400 hover:bg-blue-900/40 hover:text-blue-300 transition-transform duration-150 ease-in-out active:scale-90"
                aria-label="Edit receipt"
          >
                <Edit className="h-5 w-5" />
          </Button>
          <Button
                onClick={e => { e.stopPropagation(); handleDeleteReceipt(receipt.id); }}
            variant="ghost"
            size="icon"
                className="text-red-400 hover:bg-blue-900/40 hover:text-red-300 transition-transform duration-150 ease-in-out active:scale-90"
                aria-label="Delete receipt"
          >
                <Trash2 className="h-5 w-5" />
          </Button>
          </div>
          </div>
          {isExpanded && (
            <CardContent className="pt-4">
              <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
                  <p className="text-xs text-blue-200/70">Subtotal</p>
                  <p className="text-base">{receipt.subtotal ? parseFloat(receipt.subtotal).toFixed(2) : '-'}</p>
          </div>
          <div>
                  <p className="text-xs text-blue-200/70">Tax</p>
                  <p className="text-base">{receipt.tax ? parseFloat(receipt.tax).toFixed(2) : '-'}</p>
        </div>
          <div>
                  <p className="text-xs text-blue-200/70">Payment</p>
                  <p className="text-base">{receipt.paymentMethod || 'Not specified'}</p>
          </div>
          <div>
                  <p className="text-xs text-blue-200/70">Category</p>
                  <p className="text-base flex items-center gap-1">{receipt.category || 'Uncategorized'}
                    <span className={`inline-block w-2 h-2 rounded-full ml-1 ${catColor.replace('border-l-4', 'bg-')}`}></span>
                  </p>
                </div>
                <div>
                  <p className="text-xs text-blue-200/70">Date</p>
                  <p className="text-base">{formatDateSafely(receipt.transactionDate, 'DD MMM YYYY')}</p>
          </div>
        </div>
        {receipt.items && receipt.items.length > 0 && (
                <div className="mt-2">
                  <p className="text-xs text-blue-200/70 mb-1">Items</p>
                  <ul className="space-y-1 list-disc list-inside">
              {receipt.items.map((item, index) => (
                <li key={index} className="flex justify-between text-sm">
                        <span className="truncate max-w-[100px]">{item.name}</span>
                        <span>{parseFloat(item.price).toFixed(2)} {receipt.currency}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </CardContent>
          )}
    </Card>
      </div>
    );
  };

  const startCamera = async () => {
    console.log('startCamera called');
    console.log('video element in startCamera: ', _videoElement);
    if (!_videoElement) {
      console.error('Attempted to start camera but _videoElement is null.');
      toast({
        title: "Camera Error",
        description: "Video element not available. Please try again.",
        variant: "destructive",
      });
      setIsCameraReady(false);
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment', // Use back camera for better receipt photos
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        } 
      });
      console.log('Camera stream obtained:', stream);
      _videoElement.srcObject = stream;
      _videoElement.onloadedmetadata = () => {
        console.log('Video metadata loaded, playing video...');
        _videoElement.play()
          .then(() => {
            console.log('Video playback started successfully');
            setIsCameraReady(true);
          })
          .catch(error => {
            console.error('Error playing video:', error);
            setIsCameraReady(false);
          });
      };
      console.log('Camera stream assigned. Camera is ready.');
    } catch (error) {
      console.error("Error accessing camera:", error);
      console.error("Error name:", error.name);
      console.error("Error message:", error.message);
      toast({
        title: "Camera Access Denied",
        description: "Please grant camera access to use this feature.",
        variant: "destructive",
      });
      setIsCameraReady(false);
    }
  };

  const stopCamera = () => {
    if (_videoElement && _videoElement.srcObject) {
      const tracks = _videoElement.srcObject.getTracks();
      tracks.forEach(track => {
        track.stop();
        track.enabled = false;
      });
      _videoElement.srcObject = null;
      _videoElement = null;
      console.log('Camera stream stopped and tracks released.');
    }
    setIsCameraOpen(false);
    setIsCameraReady(false);
  };

  const capturePhoto = () => {
    if (_videoElement && canvasRef.current) {
      const context = canvasRef.current.getContext('2d');
      canvasRef.current.width = _videoElement.videoWidth;
      canvasRef.current.height = _videoElement.videoHeight;
      context.drawImage(_videoElement, 0, 0, canvasRef.current.width, canvasRef.current.height);
      
      // Convert canvas to blob and create a File object
      canvasRef.current.toBlob((blob) => {
        const capturedFile = new File([blob], 'captured-receipt.jpg', { type: 'image/jpeg' });
        setFile(capturedFile); // Set the file for OCR processing
        setPreviewImageSrc(canvasRef.current.toDataURL('image/jpeg'));
        setShowFullScreenPreview(true);
        setIsCameraOpen(false); // Close the camera modal after capturing
        stopCamera(); // Stop the camera stream
      }, 'image/jpeg', 0.9);
    }
  };

  const handleConfirmPreview = () => {
    setShowFullScreenPreview(false);
    if (file) {
      processOCR(file);
    } else {
      // Fallback: if no file object, create one from the preview image
      fetch(previewImageSrc)
        .then(res => res.blob())
        .then(blob => {
          const imageFile = new File([blob], 'receipt.jpg', { type: 'image/jpeg' });
          processOCR(imageFile);
        })
        .catch(error => {
          console.error('Error creating file from preview:', error);
          toast({
            title: "Error Processing Image",
            description: "Failed to process the captured image. Please try again.",
            variant: "destructive",
          });
        });
    }
  };

  const handleRetakePreview = () => {
    setShowFullScreenPreview(false);
    setPreviewImageSrc(null);
    setFile(null);
    setIsCameraOpen(false); // Ensure camera is closed
    setCurrentStep('upload_options'); // Go back to the upload options/method selection card
  };

  const handleEditClick = (receipt) => {
    setEditingReceipt(receipt);

    // Safely parse numbers for initial editForm state
    const safeParseFloat = (value) => {
      const parsed = parseFloat(value);
      return isNaN(parsed) ? '0.00' : parsed.toFixed(2);
    };

    setEditForm({
      merchant: receipt.merchant || '',
      total: safeParseFloat(receipt.total), // Always set 'total' as string with two decimals
      date: receipt.transactionDate || '',
      category: receipt.category || '',
      subtotal: receipt.subtotal ? safeParseFloat(receipt.subtotal) : '',
      payment_method: receipt.paymentMethod || '',
      currency: receipt.currency || 'EUR',
      items: receipt.items?.map(item => ({
        name: item.name || '',
        price: safeParseFloat(item.price)
      })) || [] // Ensure items are formatted safely
    });
    setCurrentReceipt(receipt);
    setIsEditing(true);
    setCurrentStep('receipt_form'); // Open the receipt form modal for editing
    setReturnToCategory(selectedCategory); // Save the category context
  };

  const processOCR = async (file) => {
    setIsLoading(true); // <-- Show loading overlay
    try {
      setIsOcrProcessing(true);
      setOcrError(null);
      const base64 = await toBase64(file);

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${import.meta.env.VITE_OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: `Analyze this receipt image and extract the following information in JSON format:
1. Store/Merchant name
2. Total amount
3. Subtotal (if present)
4. Date
5. Category (choose from: Groceries, Dining, Transportation, Shopping, Bills, Entertainment, Health, Other)
6. Payment Method (e.g., Cash, Credit Card, Debit Card, Mobile Payment, Bank Transfer, Voucher, Other)
7. Currency (detect from the receipt, looking for currency symbols or codes like â‚¬, $, Â£, Â¥, etc.)
8. Items (list of items with their prices)

If there are discounts (e.g., 'Discount', 'Rabatt', 'Descuento', 'Remise', 'Sconto', etc.), include each discount as an item in the 'items' array, with a negative price and a clear description (e.g., {"name": "Discount", "price": "-2.00"}). Do not use a separate 'discounts' field.

For subtotal, look for lines or sections labeled 'Subtotal', 'Sous-total', 'Zwischensumme', 'Sub-total', or similar, usually just above the tax or total. Return the value as a string if found, or leave blank/null if not present.

For payment method, use all available clues to infer the most probable method, even if not explicitly stated. Look for:
- Card numbers (e.g., ****1234, VISA, Mastercard, AMEX, Maestro, Discover, UnionPay, Carte Bancaire, etc.)
- Payment terminal info (POS, EFT, terminal IDs, Auth #, Approval #)
- Cash indicators ("Paid by cash", "cash tendered", "change given", "amount due: 0.00")
- Mobile payment ("Apple Pay", "Google Pay", "Samsung Pay", "NFC", "Contactless", "QR code", "WeChat Pay", "Alipay")
- Bank transfer ("IBAN", "BIC", "Sort code", "Bank name", "SEPA", "Wire transfer")
- Vouchers/gift cards ("Gift card", "Voucher", "Store credit")
- Split/multiple payments ("Split payment", "Partial card, partial cash")
- Payment logos or icons
- Words like 'CASH', 'CARD', 'DEBIT', 'CREDIT', 'TRANSFER', 'MOBILE', 'CONTACTLESS', etc.

If multiple payment methods are detected, return the most likely one in 'payment_method', and list alternatives in 'payment_method_alternatives' (array).
If the method is not explicit, make an educated guess based on these clues and the context. If truly unknown, return 'Other'.

Also include:
- 'payment_method_reason': a short explanation of why you chose this method.
- 'payment_method_confidence': a value from 0 (low) to 1 (high) indicating your confidence in the guess.

For currency detection, look for:
- Currency symbols (â‚¬, $, Â£, Â¥, etc.)
- Currency codes (EUR, USD, GBP, JPY, etc.)
- Regional formats (e.g., â‚¬1.234,56 for European format, $1,234.56 for US format)
- Currency indicators in the header or footer of the receipt
- Currency mentioned in the payment section
- Currency symbols next to prices

Reply with a JSON object enclosed in triple backticks like this:\n\`\`\`json
{
  "store": "Store Name",
  "amount": "23.50",
  "subtotal": "20.00",
  "date": "13/06/2025",
  "category": "Category Name",
  "payment_method": "Credit Card",
  "payment_method_alternatives": ["Cash", "Mobile Pay"],
  "payment_method_reason": "Found 'VISA' and card number ****1234 on the receipt.",
  "payment_method_confidence": 0.95,
  "currency": "EUR",
  "items": [
    {"name": "Item 1", "price": "10.00"},
    {"name": "Discount", "price": "-2.00"},
    {"name": "Item 2", "price": "13.50"}
  ]
}
\`\`\`

Note: For currency, return the standard 3-letter currency code (e.g., EUR, USD, GBP, JPY) based on the detected currency.`
                },
                { type: "image_url", image_url: { url: base64 } }
              ]
            }
          ],
          max_tokens: 500
        })
      });

      const data = await response.json();
      const replyText = data?.choices?.[0]?.message?.content || '';
      console.log("OCR Raw Response:\n", replyText);

      const jsonMatch = replyText.match(/```json\s*({[\s\S]*?})\s*```/i);
      if (!jsonMatch || !jsonMatch[1]) {
        console.error("OCR parsing error: No valid JSON block found in the response.", replyText);
        throw new Error("No valid JSON block found in the OCR response.");
      }

      const parsedJSON = JSON.parse(jsonMatch[1]);

      // Update form data with the extracted information
      // Extra validation: ensure all discount items have negative prices
      const discountKeywords = [
        'discount', 'rabatt', 'descuento', 'remise', 'sconto', 'desconto', 'skonto'
      ];
      const normalizedItems = (parsedJSON.items || []).map(item => {
        if (!item.name) return item;
        const nameLower = item.name.toLowerCase();
        const isDiscount = discountKeywords.some(keyword => nameLower.includes(keyword));
        let price = item.price;
        if (isDiscount && price) {
          // Remove currency symbols and spaces, convert to number
          let num = parseFloat(price.toString().replace(/[^\d.-]/g, ''));
          if (isNaN(num)) return item;
          if (num > 0) num = -num;
          price = num.toFixed(2);
        }
        return { ...item, price };
      });
      setFormData(prev => ({
        ...prev,
        merchant: parsedJSON.store || '',
        total: parsedJSON.amount ? parsedJSON.amount.replace(/[^\d.,]/g, '').replace(',', '.') : '',
        date: parsedJSON.date ? normalizeDate(parsedJSON.date) : new Date().toISOString().split('T')[0],
        category: parsedJSON.category || '',
        paymentMethod: parsedJSON.payment_method || '',
        currency: parsedJSON.currency || 'EUR', // Use detected currency or default to EUR
        items: normalizedItems
      }));

      setCurrentStep('receipt_form');
    } catch (error) {
      console.error('OCR error:', error);
      setOcrError('Failed to process receipt. Please try again or enter manually.');
      toast({
        title: "OCR Processing Error",
        description: "Failed to process the receipt. Please try again or enter the details manually.",
        variant: "destructive",
      });
    } finally {
      setIsOcrProcessing(false);
      setIsLoading(false); // <-- Hide loading overlay
    }
  };

  const toBase64 = (file) =>
    new Promise((resolve, reject) => {
          const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
        });

  // Add a function to reset form data with today's date
  const resetFormData = () => {
    setFormData({
      date: new Date().toISOString().split('T')[0],
      merchant: '',
      total: '',
      tax: '',
      subtotal: '',
      paymentMethod: '',
      currency: 'EUR',
      items: [],
      category: ''
    });
  };

  // Add a ref for the merchant input
  const merchantInputRef = useRef(null);

  // Update the handleManualEntry function to focus on merchant field
  const handleManualEntry = () => {
    resetFormData();
    setCurrentStep('manual_entry');
    // Use setTimeout to ensure the modal is open before focusing
    setTimeout(() => {
      merchantInputRef.current?.focus();
    }, 100);
  };

  // Add this useEffect near the top of the component, after the state declarations
  useEffect(() => {
    if (currentStep === 'receipt_form' || currentStep === 'manual_entry') {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [currentStep]);

  useEffect(() => {
    if (isLoading) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    // Cleanup function to restore scroll on component unmount
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isLoading]);

  // Add a helper to get the currency symbol
  const getCurrencySymbol = (code) => {
    const currency = SUPPORTED_CURRENCIES.find(c => c.code === code);
    return currency ? currency.symbol : code;
  };

  // Add a helper to format currency with locale-aware symbol placement and postfix exceptions
  const postfixCurrencies = ['SEK', 'NOK', 'DKK', 'PLN', 'CZK', 'HUF'];
  const formatCurrency = (amount, currencyCode = 'EUR') => {
    if (amount === null || amount === undefined) return '';
    if (postfixCurrencies.includes(currencyCode)) {
      return amount.toFixed(2) + ' ' + currencyCode;
    }
    // Pick a locale based on currency (for best symbol placement)
    let locale = 'en-US';
    if (currencyCode === 'EUR') locale = 'fr-FR';
    if (currencyCode === 'CZK') locale = 'cs-CZ';
    if (currencyCode === 'PLN') locale = 'pl-PL';
    if (currencyCode === 'GBP') locale = 'en-GB';
    if (currencyCode === 'JPY') locale = 'ja-JP';
    if (currencyCode === 'CNY') locale = 'zh-CN';
    if (currencyCode === 'AUD') locale = 'en-AU';
    if (currencyCode === 'CAD') locale = 'en-CA';
    if (currencyCode === 'CHF') locale = 'de-CH';
    try {
      return new Intl.NumberFormat(locale, {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    } catch {
      return amount + ' ' + currencyCode;
    }
  };

  // Add swipe state:
  const [swipedId, setSwipedId] = useState(null);
  const [swipeDir, setSwipeDir] = useState(null);
  const swipeRefs = useRef({});

  // Add swipe handlers:
  const handleTouchStart = (id, e) => {
    // Don't prevent default here to allow vertical scrolling
    setSwipeStartX(prev => ({ ...prev, [id]: e.touches[0].clientX }));
    setSwipeStartY(prev => ({ ...prev, [id]: e.touches[0].clientY }));
  };
  const handleTouchMove = (id, e) => {
    if (swipeStartX[id] == null || swipeStartY[id] == null) return;
    
    const dx = e.touches[0].clientX - swipeStartX[id];
    const dy = e.touches[0].clientY - swipeStartY[id];
    
    // Only handle horizontal swipes, ignore vertical movement
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
      e.preventDefault(); // Only prevent default for horizontal swipes
      e.stopPropagation();
      setSwipeOffset(prev => ({ ...prev, [id]: dx }));
    }
  };
  const handleTouchEnd = (id) => {
    const offset = swipeOffset[id] || 0;
    const card = document.getElementById(`receipt-card-${id}`);
    const width = card ? card.offsetWidth : 1;
    const threshold = width * 0.4;
    if (offset > threshold) {
      try { navigator.vibrate && navigator.vibrate(30); } catch {}
      setTimeout(() => {
        setSwipeOffset(prev => ({ ...prev, [id]: 0 }));
        setSwipeStartX(prev => ({ ...prev, [id]: undefined }));
        setSwipeStartY(prev => ({ ...prev, [id]: undefined }));
        handleEditClick(receipts.find(r => r.id === id));
      }, 150);
    } else if (offset < -threshold) {
      try { navigator.vibrate && navigator.vibrate([30, 30, 30]); } catch {}
      setTimeout(() => {
        setSwipeOffset(prev => ({ ...prev, [id]: 0 }));
        setSwipeStartX(prev => ({ ...prev, [id]: undefined }));
        setSwipeStartY(prev => ({ ...prev, [id]: undefined }));
        setPendingDeleteId(id);
        setShowDeleteModal(true);
      }, 150);
      } else {
      setSwipeOffset(prev => ({ ...prev, [id]: 0 }));
      setSwipeStartX(prev => ({ ...prev, [id]: undefined }));
      setSwipeStartY(prev => ({ ...prev, [id]: undefined }));
    }
  };

  // Add at the top of the component:
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [pendingDeleteId, setPendingDeleteId] = useState(null);

  // Add a helper to get swipe progress (0 to 1) and direction:
  const getSwipeProgress = (id) => {
    const offset = swipeOffset[id] || 0;
    const card = document.getElementById(`receipt-card-${id}`);
    const width = card ? card.offsetWidth : 1;
    const progress = Math.min(Math.abs(offset) / (width * 0.4), 1);
    const dir = offset > 0 ? 'right' : offset < 0 ? 'left' : null;
    return { progress, dir };
  };

  // Add these hooks for swipe gesture state
  const [swipeOffset, setSwipeOffset] = useState({});
  const [swipeStartX, setSwipeStartX] = useState({});
  const [swipeStartY, setSwipeStartY] = useState({});

  // --- Date helpers ---
  const today = new Date();
  let periodStart, periodEnd, periodLabel;
  if (period === 'week') {
    periodStart = new Date(today);
    periodStart.setHours(0, 0, 0, 0);
    // Start week on Monday (1) instead of Sunday (0)
    // TODO: Make week start day configurable in user settings (Monday vs Sunday)
    const dayOfWeek = today.getDay();
    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days; otherwise go back (dayOfWeek - 1) days
    periodStart.setDate(today.getDate() - daysToMonday);
    periodEnd = new Date(periodStart);
    periodEnd.setDate(periodStart.getDate() + 6); // Monday to Sunday (7 days)
    periodEnd.setHours(23, 59, 59, 999);
    const formatShort = d => d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
    periodLabel = `${formatShort(periodStart)} - ${formatShort(periodEnd)}`;
  } else {
    periodStart = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
    periodEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
    const formatShort = d => d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
    periodLabel = `${formatShort(periodStart)} - ${formatShort(periodEnd)}`;
  }

  // Helper to robustly normalize a date string/object to local midnight
  const normalizeToLocalMidnight = (d) => {
    if (!d) return null;
    if (typeof d.toDate === 'function') { d = d.toDate(); } // Handle Firestore Timestamps
    if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
      // Parse as local date (YYYY-MM-DD)
      const [year, month, day] = d.split('-').map(Number);
      return new Date(year, month - 1, day);
    }
    const date = new Date(d);
    if (isNaN(date)) return null;
    return new Date(date.getFullYear(), date.getMonth(), date.getDate());
  };

  // Filter receipts for selected period (inclusive)
  const periodReceipts = receipts.filter(r => {
    const d = normalizeToLocalMidnight(r.transactionDate || r.date || r.createdAt);
    return d && d >= periodStart && d <= periodEnd;
  });

  const allCategoryColors = {
    'Groceries': '#3b82f6',
    'Dining': '#f472b6',
    'Transportation': '#a78bfa',
    'Shopping': '#818cf8',
    'Bills': '#60a5fa',
    'Entertainment': '#fbbf24',
    'Health': '#10b981',
    'Other': '#f59e42',
    'Uncategorized': '#9ca3af'
  };

  // --- New Data Structuring for Rich Tooltips ---
  let dailyData, labelsWithDates;

  if (period === 'week') {
    const weekDates = Array.from({ length: 7 }, (_, i) => new Date(periodStart.getFullYear(), periodStart.getMonth(), periodStart.getDate() + i));
    labelsWithDates = weekDates.map(d => ({
      short: d.toLocaleDateString(undefined, { weekday: 'short' })[0],
      full: d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })
    }));
    dailyData = Array.from({ length: 7 }, () => ({ categories: {}, total: 0 }));

    periodReceipts.forEach(r => {
      const date = normalizeToLocalMidnight(r.date || r.transactionDate || r.createdAt);
      if (date) {
        // Calculate day index for Monday-Sunday week (0=Monday, 6=Sunday)
        const dayIndex = (date.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
        if (dayIndex >= 0 && dayIndex < 7) {
          const category = r.category || 'Uncategorized';
          const amount = parseFloat(r.total) || 0;
          dailyData[dayIndex].categories[category] = (dailyData[dayIndex].categories[category] || 0) + amount;
          dailyData[dayIndex].total += amount;
        }
      }
    });
  } else { // month
    const daysInMonth = periodEnd.getDate();
    labelsWithDates = Array.from({ length: daysInMonth }, (_, i) => {
      const d = new Date(periodStart.getFullYear(), periodStart.getMonth(), i + 1);
      return {
        short: (i + 1).toString(),
        full: d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })
      };
    });
    dailyData = Array.from({ length: daysInMonth }, () => ({ categories: {}, total: 0 }));

    periodReceipts.forEach(r => {
      const date = normalizeToLocalMidnight(r.date || r.transactionDate || r.createdAt);
      if (date) {
        const dayIndex = date.getDate() - 1;
        if (dayIndex >= 0 && dayIndex < daysInMonth) {
          const category = r.category || 'Uncategorized';
          const amount = parseFloat(r.total) || 0;
          dailyData[dayIndex].categories[category] = (dailyData[dayIndex].categories[category] || 0) + amount;
          dailyData[dayIndex].total += amount;
        }
      }
    });
  }
  
  const chartTotals = dailyData.map(d => d.total);
  const expenses = chartTotals.reduce((a, b) => a + b, 0);
  const spentPerDay = period === 'week' ? expenses / 7 : (chartTotals.length > 0 ? expenses / chartTotals.length : 0);
  
  const periodCategoryTotals = periodReceipts.reduce((acc, r) => {
    const cat = r.category || 'Uncategorized';
    const amt = parseFloat(r.total) || 0;
    acc[cat] = (acc[cat] || 0) + amt;
    return acc;
  }, {});
  
  const total = expenses;

  // Get all unique categories from the period
  const allCategories = [...new Set(Object.keys(periodCategoryTotals))];
  
  // Create stacked bar chart datasets
  const barDatasets = allCategories.map(category => {
    const categoryData = dailyData.map(dayData => dayData.categories[category] || 0);
    return {
      label: category,
      data: categoryData,
      backgroundColor: allCategoryColors[category] || '#9ca3af',
      borderRadius: 12,
      barPercentage: 0.6,
      categoryPercentage: 0.7,
      borderSkipped: false,
      stack: 'stack0', // This makes it a stacked bar
    };
  });

  // Bar chart data
  const barData = {
    labels: labelsWithDates.map(l => l.short),
    datasets: barDatasets,
  };
  
  // Bar chart options
  const barOptions = {
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        backgroundColor: '#1e293b',
        titleColor: '#f1f5f9',
        titleFont: { size: 14, weight: 'bold' },
        bodyColor: '#cbd5e1',
        bodyFont: { size: 12 },
        borderColor: 'rgba(99,102,241,0.5)',
        borderWidth: 1,
        displayColors: false,
        padding: 12,
        cornerRadius: 8,
        callbacks: {
          title: function(context) {
            if (!context[0]) return '';
            return labelsWithDates[context[0].dataIndex].full;
          },
          label: () => null,
          beforeBody: function(context) {
            const dataIndex = context[0].dataIndex;
            const dayData = dailyData[dataIndex];
            const sortedCategories = Object.entries(dayData.categories).sort((a, b) => b[1] - a[1]);
            if (sortedCategories.length === 0) return ['No expenses this day.'];
            return sortedCategories.map(([name, amount]) => `${name}: ${formatCurrency(amount, settings?.baseCurrency || 'EUR')}`);
          },
          footer: function(context) {
            const totalAmount = context[0].raw;
            if (totalAmount > 0) {
              return `\nTotal: ${formatCurrency(totalAmount, settings?.baseCurrency || 'EUR')}`;
            }
            return '';
          },
        },
      },
    },
    scales: {
      x: {
        grid: { drawBorder: false, color: 'rgba(226, 232, 240, 0.1)' },
        ticks: { color: '#94a3b8', font: { weight: '600' } },
      },
      y: {
        grid: { drawBorder: false, color: 'rgba(226, 232, 240, 0.1)' },
        ticks: { color: '#94a3b8' },
        beginAtZero: true,
        max: Math.max(60, Math.ceil(Math.max(...chartTotals) / 10) * 10),
      },
    },
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 800, easing: 'easeOutQuart' },
  };
  
  // Category legend with percentages
  const legend = Object.keys(periodCategoryTotals).map((cat, i) => {
    const percent = total ? ((periodCategoryTotals[cat] / total) * 100).toFixed(1) : 0;
    return { name: cat, color: allCategoryColors[cat] || '#9ca3af', percent };
  });
  
  return (
    <div className={`relative flex flex-col items-center w-full ${className}`} style={{ touchAction: 'manipulation', overflowX: 'hidden' }}>
      {/* Loading Overlay */}
      {isLoading && (
        <div className="fixed inset-0 z-[100000] bg-black/80 backdrop-blur-sm grid place-items-center overflow-hidden">
          <div className="flex flex-col items-center justify-center text-center">
            {/* Final Animation: Contained, Clipped, and now with no-scrollbar class */}
            <div className="relative mb-8 flex h-32 w-32 items-center justify-center no-scrollbar">
              {/* Soft radial glow */}
              <div className="absolute inset-0 rounded-full" style={{background: 'radial-gradient(circle, rgba(99,102,241,0.15) 0%, rgba(30,41,59,0) 70%)'}}></div>
              {/* Pulsing rings (box-shadow) */}
              <div className="absolute h-16 w-16 animate-pulse-ring rounded-full"></div>
              {/* Clipped container for confetti to prevent overflow */}
              <div className="absolute inset-0 rounded-full overflow-hidden">
                <svg className="absolute left-6 top-6 h-4 w-4 animate-bounce-slow" style={{animationDelay: '0.2s'}} viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="1.5" fill="#fbbf24"/><circle cx="14" cy="4" r="1" fill="#38bdf8"/><circle cx="3" cy="12" r="1.2" fill="#a78bfa"/></svg>
                <svg className="absolute right-6 top-8 h-3 w-3 animate-bounce-slow-delayed" style={{animationDelay: '0.6s'}} viewBox="0 0 12 12" fill="none"><rect x="6" y="1" width="1.5" height="1.5" rx=".75" fill="#f472b6"/><rect x="10" y="8" width="1" height="1" rx=".5" fill="#fbbf24"/></svg>
                <svg className="absolute left-8 bottom-6 h-2 w-2 animate-bounce-slow" style={{animationDelay: '1s'}} viewBox="0 0 8 8" fill="none"><circle cx="4" cy="4" r="1" fill="#34d399"/></svg>
              </div>
              {/* Dancing Receipt with Face */}
              <div className="animate-[wiggle_1.2s_ease-in-out_infinite] drop-shadow-2xl">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-16 w-16 text-blue-100"
                  fill="none"
                  viewBox="0 0 48 64"
                >
                  {/* Paper shape */}
                  <rect x="4" y="4" width="40" height="56" rx="6" fill="#fff" stroke="#c7d2fe" strokeWidth="2"/>
                  {/* Lines for text */}
                  <rect x="12" y="14" width="24" height="3" rx="1.5" fill="#c7d2fe"/>
                  <rect x="12" y="22" width="18" height="3" rx="1.5" fill="#c7d2fe"/>
                  <rect x="12" y="30" width="20" height="3" rx="1.5" fill="#c7d2fe"/>
                  {/* Face: Eyes (animated blink) */}
                  <ellipse cx="18" cy="44" rx="2" ry="2.2" fill="#64748b">
                    <animate attributeName="ry" values="2.2;0.5;2.2" keyTimes="0;0.5;1" dur="2s" repeatCount="indefinite"/>
                  </ellipse>
                  <ellipse cx="30" cy="44" rx="2" ry="2.2" fill="#64748b">
                    <animate attributeName="ry" values="2.2;2.2;0.5;2.2" keyTimes="0;0.3;0.5;1" dur="2s" repeatCount="indefinite"/>
                  </ellipse>
                  {/* Smile */}
                  <path d="M20 48 Q24 52 28 48" stroke="#64748b" strokeWidth="2" fill="none" strokeLinecap="round"/>
                </svg>
              </div>
            </div>
            
            {/* Text without a wrapping card/box */}
            <p className="text-xl font-medium text-white" style={{textShadow: '0 2px 8px rgba(0,0,0,0.5)'}}>Processing your receipt...</p>
            <p className="text-lg text-blue-300 animate-pulse" style={{textShadow: '0 2px 8px rgba(0,0,0,0.5)'}}>{currentFunnyMessage} <span role="img" aria-label="fun">ðŸŽ‰</span></p>
          </div>
        </div>
      )}

      {/* Main Content Area */}
      <div
        className="flex-grow flex flex-col items-center justify-start px-2 sm:px-4 lg:px-6 mt-8 mb-12"
        style={{
          touchAction: 'pan-y',
          overflowX: 'hidden',
          maxWidth: '100vw',
          width: '100vw'
        }}
      >
        {/* Dashboard Header */}
        <div className="text-center mb-8 w-full max-w-4xl px-2">
          <h1 className="text-4xl font-extrabold text-white mb-4">
            {/* Removed: Your Expense Dashboard */}
          </h1>
          <p className="text-xl text-gray-300">
            {/* Removed: Ready to conquer your expenses? Upload receipts, track spending, and gain insights with ease. */}
          </p>
        </div>

        {/* Responsive row layout for laptop/desktop, column for mobile */}
        <div className="flex flex-col md:flex-row gap-8 w-full max-w-full items-start justify-center mb-8" style={{ overflowX: 'hidden' }}>
          {/* Upload Method Card */}
          <div className={`w-full md:w-1/3 flex-col items-center mb-8 md:mb-0 ${showOnly === 'upload' ? 'flex' : !showOnly ? 'flex' : 'hidden'} md:flex`}>
            <Card className="w-full p-4 md:p-6 flex flex-col items-center justify-start gap-4 bg-slate-800/80 text-white shadow-2xl rounded-xl border border-blue-400/20">
            <CardHeader className="w-full text-center p-0 mb-4">
                <CardTitle className="text-xl md:text-2xl font-bold text-blue-100">Choose Upload Method</CardTitle>
            </CardHeader>
            <CardContent className="w-full flex flex-col items-center justify-center gap-4 p-0">
                  <input
                    type="file"
                id="fileInput"
                    ref={fileInputRef}
                onChange={handleImageChange}
                accept="image/*"
                className="hidden"
                  />
                <Button
                onClick={() => document.getElementById('fileInput').click()}
                  className="w-full bg-blue-700 text-white font-semibold py-3 rounded-xl hover:bg-blue-800 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg overflow-hidden"
                >
                <Upload className="h-5 w-5" />
                Upload File
                </Button>
              <Button
                  onClick={() => setIsCameraOpen(true)}
                  className="w-full bg-blue-700 text-white font-semibold py-3 rounded-xl hover:bg-blue-800 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg overflow-hidden"
              >
                <Camera className="h-5 w-5" />
                Take Photo
              </Button>
              <Button
                  onClick={handleManualEntry}
                  className="w-full bg-blue-700 text-white font-semibold py-3 rounded-xl hover:bg-blue-800 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg overflow-hidden"
              >
                <List className="h-5 w-5" />
                Enter Manually
              </Button>
            </CardContent>
          </Card>
          </div>

          {/* Financial Overview Card */}
          <div className={`w-full md:w-1/3 flex-col items-center mb-8 md:mb-0 ${showOnly === 'expenses' ? 'flex' : !showOnly ? 'flex' : 'hidden'} md:flex`}>
            <ExpensesDashboard
              totalExpenses={totalExpenses}
              categoryTotals={categoryTotals}
              formatCurrency={formatCurrency}
              settings={settings}
              receipts={receipts}
              selectedCategory={selectedCategory}
              setSelectedCategory={setSelectedCategory}
              modalOpen={modalOpen}
              setModalOpen={setModalOpen}
            />
            {/* Insights Section */}
            <InsightsSection
              receipts={receipts}
              categoryTotals={categoryTotals}
              formatCurrency={formatCurrency}
              settings={settings}
            />
          </div>

          {/* Your Receipts Card */}
          <div className={`w-full md:w-1/3 flex-col items-center ${showOnly === 'receipts' ? 'flex' : !showOnly ? 'flex' : 'hidden'} md:flex`}>
            <Card className="w-full p-4 md:p-6 flex flex-col items-center justify-start gap-4 bg-slate-800/80 text-white shadow-2xl rounded-2xl border border-blue-400/20">
            <CardHeader className="w-full text-center p-0 mb-4">
                <CardTitle className="text-xl font-bold text-blue-100">Your Receipts</CardTitle>
            </CardHeader>
            <CardContent className="w-full flex flex-col items-center justify-center p-0">
                {isFirestoreLoading ? (
                  <div className="flex flex-col items-center justify-center text-gray-400">
                    <Loader2 className="h-8 w-8 animate-spin mb-2" />
                    <p>{currentFunnyMessage}</p>
                  </div>
                ) : firestoreError ? (
                  <div className="text-center text-red-400">
                    <XCircle className="h-8 w-8 mx-auto mb-2" />
                    <p>{firestoreError}</p>
                    <Button onClick={fetchReceipts} className="mt-4">Try Again</Button>
                  </div>
                ) : receipts.length === 0 ? (
                  <div className="text-center">
                    <p className="text-xl text-slate-400 font-semibold mb-2">No receipts yet!</p>
                    <p className="text-md text-slate-500">
                      It's a blank canvas for your financial journey. <br />
                      Start by <span className="text-blue-400 font-medium">uploading your first receipt</span> or <span className="text-blue-400 font-medium">adding one manually</span>.
                      </p>
                    </div>
                ) : (
                  <div className="grid grid-cols-1 gap-4 w-full md:max-h-[400px] md:overflow-y-auto md:overflow-x-hidden mb-12">
                    {receipts.map((receipt) => renderReceiptCard(receipt))}
                    </div>
                )}
            </CardContent>
          </Card>
          </div>
        </div>

        {/* Receipt Form Modal (for Manual Entry and OCR-populated forms) */}
        <Dialog 
          open={currentStep === 'receipt_form' || currentStep === 'manual_entry'} 
          onOpenChange={(open) => {
          if (!open) {
              handleCloseReceiptForm();
            }
          }}
        >
          <DialogContent 
            className="w-[90vw] max-w-lg md:max-w-2xl bg-gradient-to-b from-blue-900 via-slate-900/95 to-slate-900 text-white border-none p-1 md:p-4 rounded-2xl shadow-2xl animate-fade-in-up overflow-visible max-h-[90vh] z-50 flex flex-col"
            style={{ touchAction: 'manipulation', backdropFilter: 'blur(10px)' }}
            onPointerDownOutside={e => e.preventDefault()}
            onInteractOutside={e => e.preventDefault()}
          >
            <DialogHeader className="mb-1 animate-fade-in duration-300 ease-in-out">
              <DialogTitle className="text-xl md:text-2xl font-bold text-blue-200 text-center tracking-tight">{editingReceipt ? 'Edit Receipt' : 'New Receipt'}</DialogTitle>
              <DialogDescription className="text-blue-300/80 text-center text-sm md:text-base">{editingReceipt ? 'Edit your receipt details below.' : 'Enter your receipt details below.'}</DialogDescription>
            </DialogHeader>
            <div className="flex-1 overflow-y-auto max-h-[55vh] px-0 md:px-0">
              <form onSubmit={handleSaveReceiptSubmit} autoComplete="off" className="space-y-2 md:space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-1 md:gap-2 animate-fade-in duration-200 ease-in-out">
                  {/* Date Field - world class UX/UI */}
                  <div className="space-y-2">
                    <Label htmlFor="date">Date</Label>
                    <Input
                      id="date"
                      name="date"
                      type="date"
                      value={activeFormData.date}
                      onChange={handleFormInputChange}
                      className="w-full bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                    />
                    {formErrors.date && <p className="text-red-400 text-xs mt-1 animate-fade-in duration-200 ease-in-out">{formErrors.date}</p>}
                  </div>
                  {/* Merchant Field */}
                  <div className="space-y-2">
                    <Label htmlFor="merchant">Merchant</Label>
                    <Input
                      id="merchant"
                      name="merchant"
                      ref={merchantInputRef}
                      value={activeFormData.merchant}
                      onChange={handleFormInputChange}
                      className="bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                      placeholder="Enter merchant name"
                      autoCapitalize="words"
                      autoFocus
                      inputMode="text"
                    />
                    {formErrors.merchant && <p className="text-red-400 text-xs mt-1 animate-fade-in duration-200 ease-in-out">{formErrors.merchant}</p>}
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="total">Total Amount</Label>
                    <div className="flex items-center">
                    <Input
                        id="total"
                        name="total"
                      type="number"
                        inputMode="decimal"
                        step="0.01"
                      placeholder="0.00"
                        value={activeFormData.total}
                        onChange={handleFormInputChange}
                        className="w-full bg-slate-800/90 border border-blue-700/40 text-white text-right focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                      />
                      <span className="ml-2 text-blue-200 text-sm">{getCurrencySymbol(activeFormData.currency)}</span>
                    </div>
                    {formErrors.total && <p className="text-red-400 text-xs mt-1 animate-fade-in duration-200 ease-in-out">{formErrors.total}</p>}
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="subtotal">Subtotal <span className="text-blue-200/60">(Optional)</span></Label>
                    <div className="flex items-center">
                    <Input
                        id="subtotal"
                        name="subtotal"
                        type="number"
                        inputMode="decimal"
                        step="0.01"
                        placeholder="0.00"
                        value={activeFormData.subtotal}
                        onChange={handleFormInputChange}
                        className="w-full bg-slate-800/90 border border-blue-700/40 text-white text-right focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                      />
                      <span className="ml-2 text-blue-200 text-sm">{getCurrencySymbol(activeFormData.currency)}</span>
                    </div>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="paymentMethod">Payment Method</Label>
                    <Select
                      value={activeFormData.paymentMethod}
                      onValueChange={value => handleFormInputChange({ target: { name: 'paymentMethod', value } })}
                      onOpenChange={open => {
                        if (open && document.activeElement && document.activeElement.tagName === 'INPUT') {
                          document.activeElement.blur();
                        }
                      }}
                    >
                      <SelectTrigger className="w-full bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none">
                        <SelectValue placeholder="Select payment method" />
                      </SelectTrigger>
                      <SelectContent className="bg-blue-950 text-white border-blue-700/40 shadow-xl rounded-xl animate-fade-in-up max-h-60 overflow-y-auto">
                        {['Cash', 'Credit Card', 'Debit Card', 'Mobile Pay', 'Bank Transfer', 'Other'].map(method => (
                          <SelectItem
                            key={method}
                            value={method}
                            className="text-white bg-blue-950 hover:bg-blue-800 focus:bg-blue-800 data-[state=checked]:bg-blue-900 data-[state=checked]:text-blue-200 transition-colors duration-150 rounded-lg px-4 py-3 cursor-pointer text-base"
                          >
                            {method}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="category">Category</Label>
                    <Select
                      value={activeFormData.category}
                      onValueChange={value => handleFormInputChange({ target: { name: 'category', value } })}
                      onOpenChange={open => {
                        if (open && document.activeElement && document.activeElement.tagName === 'INPUT') {
                          document.activeElement.blur();
                        }
                      }}
                    >
                      <SelectTrigger className="w-full bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none">
                        <SelectValue placeholder="Select category" />
                      </SelectTrigger>
                      <SelectContent className="bg-blue-950 text-white border-blue-700/40 shadow-xl rounded-xl animate-fade-in-up max-h-60 overflow-y-auto">
                        {categories.map(cat => (
                          <SelectItem
                            key={cat}
                            value={cat}
                            className="text-white bg-blue-950 hover:bg-blue-800 focus:bg-blue-800 data-[state=checked]:bg-blue-900 data-[state=checked]:text-blue-200 transition-colors duration-150 rounded-lg px-4 py-3 cursor-pointer text-base"
                          >
                            {cat}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="border-t border-blue-700/30 my-4" />
                <div className="mt-2">
                  <h3 className="text-base font-semibold text-blue-100 mb-2 animate-fade-in duration-200 ease-in-out">Items</h3>
                  {(activeFormData.items || []).map((item, index) => (
                    <div key={index} className="flex items-center gap-2 mb-2 animate-fade-in-up transition-transform duration-200 ease-in-out hover:scale-[1.02]">
                              <Input
                        id={`item-name-${index}`}
                                placeholder="Item Name"
                        value={item.name || ''}
                        onChange={e => handleItemInputChange(e, index, 'name')}
                        className="flex-[2] min-w-0 bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                        autoCapitalize="words"
                        inputMode="text"
                              />
                              <Input
                        id={`item-price-${index}`}
                        type="number"
                        inputMode="decimal"
                        placeholder="0.00"
                        value={item.price}
                        onChange={e => handleItemInputChange(e, index, 'price')}
                        onBlur={e => {
                          const value = e.target.value;
                          const parsed = parseFloat(value.replace(',', '.')).toFixed(2);
                          handleItemInputChange({ target: { value: isNaN(parsed) ? '' : parsed } }, index, 'price');
                        }}
                        className="flex-[1] min-w-0 bg-slate-800/90 border border-blue-700/40 text-white text-right focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                      />
                      <span className="text-blue-200 text-sm">{getCurrencySymbol(activeFormData.currency)}</span>
                        <Button
                          type="button"
                        onClick={() => {
                          const targetStateSetter = editingReceipt ? setEditForm : setFormData;
                          targetStateSetter(prev => ({
                            ...prev,
                            items: (prev.items || []).filter((_, i) => i !== index)
                          }));
                          if (editingReceipt) {
                            setCurrentReceipt(prev => ({
                              ...prev,
                              items: (prev.items || []).filter((_, i) => i !== index)
                            }));
                          }
                        }}
                          variant="ghost"
                          size="icon"
                        className="text-red-400 hover:bg-blue-900/40 hover:text-red-300 transition-transform duration-150 ease-in-out active:scale-90"
                        aria-label="Remove item"
                        >
                        <svg className="h-5 w-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </Button>
                        </div>
                  ))}
                  <div className="flex items-end gap-2 mt-2 animate-fade-in-up duration-200 ease-in-out">
                    <div className="flex-1 min-w-0">
                      <Label htmlFor="new-item-name">New Item Name</Label>
                        <Input
                        id="new-item-name"
                          type="text"
                        placeholder="Add new item name"
                        value={editingReceipt ? currentNewItem.name : newItem.name}
                        onChange={e => editingReceipt ? setCurrentNewItem({ ...currentNewItem, name: e.target.value }) : setNewItem({ ...newItem, name: e.target.value })}
                        className="w-full bg-slate-800/90 border border-blue-700/40 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                        autoCapitalize="words"
                        inputMode="text"
                        />
                    </div>
                    <div className="w-20 md:w-28 min-w-0">
                      <Label htmlFor="new-item-price">Price</Label>
                        <Input
                          id="new-item-price"
                          type="number"
                        inputMode="decimal"
                          placeholder="0.00"
                        value={editingReceipt ? currentNewItem.price : newItem.price}
                        onChange={e => editingReceipt ? setCurrentNewItem(prev => ({ ...prev, price: e.target.value })) : setNewItem(prev => ({ ...prev, price: e.target.value }))}
                        className="w-full bg-slate-800/90 border border-blue-700/40 text-white text-right focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:bg-blue-950/80 transition-all duration-200 ease-in-out rounded-xl shadow-inner px-4 py-3 text-base placeholder-blue-200/60 outline-none"
                      />
                      </div>
                    <div className="flex flex-col justify-end pb-1">
                      <span className="text-blue-200 text-sm">{getCurrencySymbol(activeFormData.currency)}</span>
                  </div>
                  <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={editingReceipt ? handleEditItemAdd : handleAddItem}
                      disabled={editingReceipt ? (!currentNewItem.name.trim() || !currentNewItem.price.trim()) : (!newItem.name.trim() || !newItem.price.trim())}
                      className="text-blue-400 hover:bg-blue-900/40 hover:text-blue-300 transition-transform duration-150 ease-in-out active:scale-90"
                      aria-label="Add item"
                    >
                      <svg className="h-5 w-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                  </Button>
                </div>
                  {formErrors.items && <p className="text-red-400 text-xs mt-1 animate-fade-in duration-200 ease-in-out">{formErrors.items}</p>}
          </div>
              </form>
            </div>
            <div className="flex justify-end gap-2 pt-2 border-t border-blue-700/30 mt-2 bg-transparent">
                <Button
                    type="button" 
                    variant="secondary" 
                    onClick={handleCloseReceiptForm}
                className="bg-slate-700/90 hover:bg-blue-900 text-white text-base py-3 rounded-xl shadow-md transition-all duration-150 ease-in-out px-4 md:px-8"
                  >
                    Cancel
                </Button>
                  <Button 
                    type="submit" 
                onClick={handleSaveReceiptSubmit}
                className="bg-gradient-to-r from-blue-700 via-blue-600 to-blue-800 hover:from-blue-800 hover:to-blue-900 text-white text-base font-semibold py-3 rounded-xl shadow-xl transition-all duration-200 ease-in-out transform hover:scale-105 px-4 md:px-8"
              >
                {isBusy ? <span className="animate-spin mr-2">â³</span> : (editingReceipt ? 'Save Changes' : 'Save Receipt')}
                  </Button>
            </div>
          </DialogContent>
        </Dialog>
                  </div>

      {/* Full Screen Preview */}
      {showFullScreenPreview && (
        <div className="fixed inset-0 z-[100] bg-black flex flex-col animate-fade-in">
          <img src={previewImageSrc} alt="Preview" className="flex-1 object-contain" />
          <div className="absolute bottom-0 left-0 right-0 flex justify-center items-center gap-4 p-4 bg-gradient-to-t from-black/80 to-transparent pb-24">
            <Button
              onClick={handleRetakePreview}
              variant="outline"
              className="text-lg py-3 px-6 bg-slate-700/80 border-slate-500 hover:bg-slate-600 text-white backdrop-blur-sm"
            >
              <XCircle className="h-5 w-5 mr-2" />
              Retake
            </Button>
            <Button
              onClick={handleConfirmPreview}
              className="text-lg py-3 px-6 bg-blue-600/80 hover:bg-blue-500 text-white backdrop-blur-sm"
            >
              <CheckCircle className="h-5 w-5 mr-2" />
              Use Photo
            </Button>
          </div>
        </div>
      )}

      {/* Camera View */}
      <Dialog open={isCameraOpen} onOpenChange={(open) => {
        if (!open) {
          stopCamera(); // Ensure camera is stopped when modal is closed
        }
        setIsCameraOpen(open);
      }}>
        <DialogContent className="sm:max-w-[600px] bg-slate-800 text-white border-gray-700 p-6 rounded-lg shadow-xl animate-fade-in flex flex-col items-center">
          <DialogHeader className="mb-4">
            <DialogTitle className="text-2xl font-bold text-gray-100">Take Photo</DialogTitle>
            <DialogDescription className="text-gray-400">
              Position your receipt within the frame and click capture.
            </DialogDescription>
          </DialogHeader>
          <div className="relative w-full max-w-[560px] h-[420px] bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center">
            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover"></video>
            {!isCameraReady && (
              <p className="absolute text-gray-400">Camera not ready or access denied.</p>
            )}
            {/* Funny Guide Frame for Receipt positioning */}
            <div className="absolute inset-0 flex items-center justify-center p-8 pointer-events-none">
              <div className="w-full h-full border-2 border-dashed border-blue-400 rounded-lg opacity-70 flex items-center justify-center text-blue-300 text-sm font-semibold text-center leading-tight">
                Position your<br/>receipt here!<br/>(Scan me!) ðŸ“¸
              </div>
            </div>
            <canvas ref={canvasRef} className="hidden"></canvas>
            </div>
          <div className="mt-4 flex space-x-4">
            <Button onClick={stopCamera} className="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded">
              <X className="h-5 w-5 mr-2" /> Close Camera
            </Button>
            <Button onClick={capturePhoto} disabled={!isCameraReady} className="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded">
              <Camera className="h-5 w-5 mr-2" /> Capture Photo
            </Button>
          </div>
        </DialogContent>
      </Dialog>
      <footer className="w-full text-center py-4 text-gray-400 text-sm mt-8 mb-4">
        Powered with <span className="animate-very-slow-pulse inline-block">â¤ï¸</span> by ExpenseApp
      </footer>
      <Dialog open={showDeleteModal} onOpenChange={setShowDeleteModal}>
        <DialogContent className="max-w-xs bg-red-600/95 text-white border-none rounded-2xl shadow-2xl animate-fade-in-up">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2 text-lg font-bold">
              <Trash2 className="h-6 w-6 text-yellow-200 animate-bounce" />
              Delete Receipt?
            </DialogTitle>
            <DialogDescription className="text-white/80 mt-2">
              This action <span className="font-bold text-yellow-200">cannot be undone</span>.<br />
              Are you sure you want to send this receipt to the digital shredder?
            </DialogDescription>
          </DialogHeader>
          <div className="flex justify-end gap-3 mt-6">
            <Button
              variant="ghost"
              className="bg-white/10 text-white hover:bg-white/20 rounded-lg px-4 py-2"
              onClick={() => { setShowDeleteModal(false); setPendingDeleteId(null); }}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              className="bg-yellow-400 text-red-700 font-bold hover:bg-yellow-300 rounded-lg px-4 py-2 shadow-md animate-pulse"
              onClick={() => {
                if (pendingDeleteId) handleDeleteReceipt(pendingDeleteId);
                setShowDeleteModal(false); setPendingDeleteId(null);
              }}
            >
              <Trash2 className="inline-block mr-1 h-5 w-5" /> Delete
            </Button>
          </div>
        </DialogContent>
      </Dialog>
      {/* Category Details Modal */}
      <Dialog open={modalOpen} onOpenChange={setModalOpen}>
        <DialogContent className="max-w-md w-[95vw] bg-slate-900/95 text-white rounded-2xl shadow-2xl animate-fade-in-up p-0 flex flex-col overflow-hidden">
          {selectedCategory && (
            <>
              <DialogHeader className="p-6 pb-4 flex-shrink-0 border-b border-white/10">
                <DialogTitle className="flex items-center gap-3 text-2xl font-bold text-indigo-200 tracking-tight overflow-hidden">
                  <span className="text-3xl flex-shrink-0">{selectedCategory.emoji}</span>
                  <span className="truncate min-w-0">{selectedCategory.name}</span>
                </DialogTitle>
                <DialogDescription className="text-blue-200/80 mt-1 text-sm">
                  Category breakdown, recent receipts, and stats.
                </DialogDescription>
              </DialogHeader>

              <ScrollArea className="flex-1">
                <div className="p-6 flex flex-col gap-4 overflow-x-hidden">
                  {/* Amount and percent */}
                  <div className="flex flex-row items-center justify-between mb-2">
                    <div>
                      <div className="text-2xl font-extrabold text-indigo-300">{formatCurrency(selectedCategory.amount, settings?.baseCurrency || 'EUR')}</div>
                      <div className="text-xs text-gray-400">{selectedCategory.percent}% of total</div>
                    </div>
                    {/* Mini bar chart for this category by day (last 7 days) */}
                    <div className="w-28 h-16 flex items-end">
                      {/* Mini bar chart */}
                      {(() => {
                        // Prepare mini bar chart data for this category (last 7 days)
                        const today = new Date();
                        const days = Array.from({ length: 7 }, (_, i) => {
                          const d = new Date(today);
                          d.setDate(today.getDate() - (6 - i));
                          return d;
                        });
                        const dayLabels = days.map(d => d.toLocaleDateString(undefined, { weekday: 'short' }));
                        const dayTotals = days.map(d => {
                          const dStr = d.toISOString().split('T')[0];
                          return receipts.filter(r =>
                            (r.category || 'Uncategorized') === selectedCategory.name &&
                            (r.transactionDate === dStr || (r.transactionDate && r.transactionDate.startsWith(dStr)))
                          ).reduce((sum, r) => sum + (parseFloat(r.total) || 0), 0);
                        });
                        const maxVal = Math.max(...dayTotals, 1);
                        return (
                          <div className="flex items-end w-full h-full">
                            {dayTotals.map((val, i) => (
                              <div key={i} className="flex-1 flex flex-col items-center justify-end h-full">
                                <div
                                  className="rounded-full"
                                  style={{
                                    width: 10,
                                    height: `${Math.max(8, (val / maxVal) * 48)}px`,
                                    background: selectedCategory.color,
                                    opacity: val > 0 ? 1 : 0.25,
                                    transition: 'height 0.4s cubic-bezier(.4,2,.3,1)',
                                  }}
                                ></div>
                                <div className="text-[10px] text-gray-400 mt-1">{dayLabels[i][0]}</div>
                              </div>
                            ))}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                  {/* Recent receipts for this category */}
                  <div>
                    <div className="text-sm font-semibold text-blue-200 mb-1">Recent Receipts</div>
                    <div className="flex flex-col gap-2">
                      {receipts.filter(r => (r.category || 'Uncategorized') === selectedCategory.name)
                        .sort((a, b) => {
                          const da = new Date(a.transactionDate || a.date || a.createdAt);
                          const db = new Date(b.transactionDate || b.date || b.createdAt);
                          return db - da;
                        })
                        .slice(0, 5)
                        .map((r, idx) => {
                          const isExpanded = expandedInCategoryModalId === r.id;
                          return (
                            <div key={r.id || idx} className="bg-slate-800/80 rounded-lg shadow-inner overflow-hidden transition-all duration-300 ease-in-out">
                              <button
                                className="w-full grid grid-cols-[1fr_auto] items-center gap-x-2 px-3 py-2 text-left"
                                onClick={() => setExpandedInCategoryModalId(isExpanded ? null : r.id)}
                              >
                                {/* Left side: Merchant and Amount */}
                                <div className="flex flex-col overflow-hidden">
                                  <span className="font-medium text-white text-sm truncate">{r.merchant || 'Unknown'}</span>
                                  <span className="text-xs text-gray-400">{formatCurrency(r.total, r.currency || settings?.baseCurrency || 'EUR')}</span>
                                </div>
                                {/* Right side: Date and Icon */}
                                <div className="flex items-center gap-3 text-right whitespace-nowrap">
                                  <div className="flex flex-col items-end">
                                    <span className="text-xs text-blue-200">{r.transactionDate ? new Date(r.transactionDate).toLocaleDateString() : ''}</span>
                                    <span className="text-xs text-gray-400">{r.paymentMethod || ''}</span>
                                  </div>
                                  <div className="transition-transform duration-300" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                                    <ChevronDown className="h-5 w-5 text-blue-400 flex-shrink-0" />
                                  </div>
                                </div>
                              </button>
                              {/* Expanded content */}
                              <div
                                style={{ maxHeight: isExpanded ? '250px' : '0px' }}
                                className="transition-all duration-300 ease-in-out"
                              >
                                <div className="p-3 border-t border-white/10">
                                  <div className="text-xs text-gray-400 mb-1">Items:</div>
                                  {r.items && r.items.length > 0 ? (
                                    <ul className="text-xs text-gray-300 space-y-0.5">
                                      {r.items.map((item, i) => (
                                        <li key={i} className="flex justify-between">
                                          <span>{item.name}</span>
                                          <span>{formatCurrency(item.price, r.currency || settings?.baseCurrency || 'EUR')}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  ) : (
                                    <p className="text-xs text-gray-500">No items listed.</p>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                </div>
              </ScrollArea>
              <DialogFooter className="p-4 border-t border-white/10">
                <Button onClick={() => setModalOpen(false)}>Close</Button>
              </DialogFooter>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}

export function UploadMethodModal({
  file,
  fileInputRef,
  handleImageChange,
  onUploadFile,
  onTakePhoto,
  onManualEntry,
  className = '',
}) {
  return (
    <Card className={`w-full max-w-sm p-6 ${className}`}>
      <CardHeader>
        <CardTitle className="flex items-center"><Upload className="mr-2" /> Upload Receipt</CardTitle>
      </CardHeader>
      <CardContent className="flex flex-col gap-4">
        <input
          type="file"
          id="fileInput"
          ref={fileInputRef}
          onChange={handleImageChange}
          accept="image/*"
          className="hidden"
        />
        <Button onClick={() => document.getElementById('fileInput').click()} className="w-full">
          <Upload className="mr-2 h-4 w-4" /> Upload File
        </Button>
        <Button onClick={onTakePhoto} className="w-full">
          <Camera className="mr-2 h-4 w-4" /> Take Photo
        </Button>
        <Button onClick={onManualEntry} className="w-full">
          <List className="mr-2 h-4 w-4" /> Enter Manually
        </Button>
      </CardContent>
    </Card>
  );
}

export function ExpensesDashboard({ totalExpenses, categoryTotals, formatCurrency, settings, receipts = [], selectedCategory, setSelectedCategory, modalOpen, setModalOpen }) {
  // --- Semi-Circle Doughnut Data ---
  const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
  const categoryLabels = sortedCategories.map(c => c[0]);
  const categoryData = sortedCategories.map(c => c[1]);
  const categoryColors = [
    '#6366F1', '#22D3EE', '#F472B6', '#FBBF24', '#34D399', '#818CF8', '#F87171', '#A3E635', '#F59E42', '#60A5FA', '#F43F5E', '#10B981', '#EAB308', '#8B5CF6', '#FDE68A', '#FCA5A5', '#6EE7B7', '#F9A8D4', '#FCD34D', '#C7D2FE'
  ];

  // Get current month for context
  const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short' });
  const currentYear = new Date().getFullYear();

  const doughnutData = {
    labels: categoryLabels,
    datasets: [
      {
        data: categoryData,
        backgroundColor: categoryLabels.map((_, i) => categoryColors[i % categoryColors.length]),
        borderWidth: 3,
        borderColor: '#181e2a',
        hoverBorderColor: '#6366F1',
      },
    ],
  };
  // --- UI ---
  return (
    <div className="w-full max-w-2xl mx-auto mt-4 mb-4 px-2">
      <div className="bg-slate-800/60 backdrop-blur-lg shadow-2xl rounded-3xl border border-blue-400/20 p-6 flex flex-col items-center glass-card" style={{overflow: 'hidden', background: 'rgba(30,41,59,0.65)', boxShadow: '0 8px 32px 0 rgba(31, 38, 135, 0.18)', border: '1.5px solid rgba(99,102,241,0.12)', backdropFilter: 'blur(18px)'}}>
        {/* Modern Semi-Circle Doughnut Chart (restored) */}
        <div className="w-full flex flex-col items-center justify-center mb-6 relative group no-scrollbar overflow-hidden" style={{height: 140, maxHeight: 180, transition: 'transform 0.3s cubic-bezier(.4,2,.3,1)', willChange: 'transform'}}>
          <Doughnut
            data={doughnutData}
            options={{
              circumference: 180,
              rotation: -90,
              cutout: '80%',
              animation: { animateRotate: true, duration: 1200, easing: 'easeOutQuart' },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: ctx => {
                      const value = ctx.raw;
                      const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                      const percent = ((value / total) * 100).toFixed(1);
                      return `${ctx.label}: ${formatCurrency(value, settings?.baseCurrency || 'EUR')} (${percent}%)`;
                    },
                  },
                  backgroundColor: '#22223b',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: '#6366F1',
                  borderWidth: 1,
                  displayColors: false,
                  padding: 12,
                },
              },
              elements: {
                arc: {
                  borderCapStyle: 'round',
                  borderJoinStyle: 'round',
                  borderRadius: 99,
                  shadowBlur: 10,
                  shadowColor: 'rgba(99,102,241,0.18)',
                },
              },
              responsive: true,
              maintainAspectRatio: false,
            }}
            height={140}
            style={{overflow: 'hidden'}}
          />
          {/* Centered stats overlay */}
          <div className="absolute left-0 right-0 top-0 flex flex-col items-center justify-center pointer-events-none group-hover:scale-105 group-hover:shadow-blue-400/30 transition-transform duration-200 px-2 md:px-0 no-scrollbar overflow-hidden" style={{height: 100, marginTop: 30}}>
            {/* Minimalistic month indicator */}
            <div className="text-[10px] font-medium text-blue-300/70 mb-1 tracking-wider uppercase overflow-hidden" style={{letterSpacing: 1.5}}>
              {currentMonth} {currentYear}
            </div>
            <div className="text-xs font-semibold text-gray-300 mb-1 tracking-wide overflow-hidden" style={{letterSpacing: 1}}>TOTAL SPENT</div>
            <div className="text-3xl xs:text-4xl md:text-5xl font-extrabold text-indigo-200 mb-1 text-center" style={{overflow: 'hidden', whiteSpace: 'nowrap', maxWidth: '100%', padding: '0 0.5rem'}}>{formatCurrency(totalExpenses, settings?.baseCurrency || 'EUR')}</div>
            <div className="text-xs text-gray-400 overflow-hidden">{categoryLabels.length} categories</div>
          </div>
        </div>
        {/* Category Cards Grid (mobile-friendly) */}
        <div className="w-full grid grid-cols-1 gap-4 mb-4 md:grid-cols-2">
          {sortedCategories.map(([cat, amt], idx) => {
            const percent = totalExpenses > 0 ? Math.min(100, Math.round((amt / totalExpenses) * 100)) : 0;
            const color = categoryColors[categoryLabels.indexOf(cat) % categoryColors.length];
            const emoji = cat === 'Groceries' ? 'ðŸ›’' : cat === 'Dining' ? 'ðŸ½ï¸' : cat === 'Transport' ? 'ðŸšŒ' : cat === 'Bills' ? 'ðŸ’¡' : cat === 'Entertainment' ? 'ðŸŽ¬' : cat === 'Health' ? 'ðŸ’Š' : cat === 'Family' ? 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦' : 'ðŸ’¸';
            const daysLeft = cat === 'Groceries' ? 20 : cat === 'Dining' ? 7 : cat === 'Transport' ? 6 : cat === 'Bills' ? 15 : 10;
            return (
              <button
                key={cat}
                className="rounded-2xl bg-slate-900/80 shadow-lg p-3 flex flex-col gap-2 items-start border border-blue-400/10 relative overflow-hidden cursor-pointer transition-transform duration-200 hover:scale-105 hover:shadow-blue-400/30 active:scale-95 w-full focus:outline-none focus:ring-2 focus:ring-blue-400"
                style={{boxShadow: '0 2px 12px 0 rgba(99,102,241,0.08)', border: `1.5px solid ${color}33`, minHeight: 128, touchAction: 'manipulation'}}
                onClick={() => { setSelectedCategory({ name: cat, amount: amt, percent, color, emoji }); setModalOpen(true); }}
                tabIndex={0}
                aria-label={`Show details for ${cat}`}
              >
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-2xl">{emoji}</span>
                  <span className="font-semibold text-base text-white/90">{cat}</span>
                  <span className="ml-auto text-xs text-gray-400">{daysLeft} days left</span>
                </div>
                <div className="flex items-end gap-2">
                  <span className="text-xl md:text-2xl font-extrabold text-white">{formatCurrency(amt, settings?.baseCurrency || 'EUR')}</span>
                  <span className="text-xs text-green-400 font-bold">{percent}%</span>
                </div>
                {/* Progress Bar */}
                <div className="w-full h-2 rounded-full bg-slate-700/60 mt-1 mb-1 overflow-hidden">
                  <div
                    className="h-2 rounded-full transition-all duration-700"
                    style={{ width: `${percent}%`, background: color, boxShadow: `0 0 8px 0 ${color}80` }}
                  ></div>
                </div>
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
}

export function ReceiptsList({ receipts, renderReceiptCard, isFirestoreLoading, firestoreError, fetchReceipts, currentFunnyMessage, settings }) {
  return (
    <Card className="w-full max-w-sm p-6">
      <CardHeader>
        <CardTitle>Your Receipts</CardTitle>
      </CardHeader>
      <CardContent>
        {isFirestoreLoading ? (
          <div className="flex items-center justify-center text-gray-500">
            <Loader2 className="h-8 w-8 animate-spin mr-2" />
            <p>{currentFunnyMessage}</p>
          </div>
        ) : firestoreError ? (
          <div className="text-center text-red-500">
            <p>{firestoreError}</p>
            <Button onClick={fetchReceipts} className="mt-4">Try Again</Button>
          </div>
        ) : receipts.length === 0 ? (
          <p className="text-center text-gray-500">No receipts yet. Upload one to get started!</p>
        ) : (
          <div className="grid grid-cols-1 gap-4 max-h-[400px] overflow-y-auto">
            {receipts.map((receipt) => renderReceiptCard(receipt))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

function InsightsSection({ receipts = [], categoryTotals = {}, formatCurrency, settings }) {
  const [period, setPeriod] = useState('week');

  // --- Date helpers ---
  const today = new Date();
  let periodStart, periodEnd, periodLabel;
  if (period === 'week') {
    periodStart = new Date(today);
    periodStart.setHours(0, 0, 0, 0);
    // Start week on Monday (1) instead of Sunday (0)
    const dayOfWeek = today.getDay();
    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days; otherwise go back (dayOfWeek - 1) days
    periodStart.setDate(today.getDate() - daysToMonday);
    periodEnd = new Date(periodStart);
    periodEnd.setDate(periodStart.getDate() + 6); // Monday to Sunday (7 days)
    periodEnd.setHours(23, 59, 59, 999);
    const formatShort = d => d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
    periodLabel = `${formatShort(periodStart)} - ${formatShort(periodEnd)}`;
  } else {
    periodStart = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
    periodEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
    const formatShort = d => d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
    periodLabel = `${formatShort(periodStart)} - ${formatShort(periodEnd)}`;
  }

  // Helper to robustly normalize a date string/object to local midnight
  const normalizeToLocalMidnight = (d) => {
    if (!d) return null;
    if (typeof d.toDate === 'function') { d = d.toDate(); } // Handle Firestore Timestamps
    if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
      // Parse as local date (YYYY-MM-DD)
      const [year, month, day] = d.split('-').map(Number);
      return new Date(year, month - 1, day);
    }
    const date = new Date(d);
    if (isNaN(date)) return null;
    return new Date(date.getFullYear(), date.getMonth(), date.getDate());
  };

  // Filter receipts for selected period (inclusive)
  const periodReceipts = receipts.filter(r => {
    const d = normalizeToLocalMidnight(r.transactionDate || r.date || r.createdAt);
    return d && d >= periodStart && d <= periodEnd;
  });

  const allCategoryColors = {
    'Groceries': '#3b82f6',
    'Dining': '#f472b6',
    'Transportation': '#a78bfa',
    'Shopping': '#818cf8',
    'Bills': '#60a5fa',
    'Entertainment': '#fbbf24',
    'Health': '#10b981',
    'Other': '#f59e42',
    'Uncategorized': '#9ca3af'
  };

  // --- New Data Structuring for Rich Tooltips ---
  let dailyData, labelsWithDates;

  if (period === 'week') {
    const weekDates = Array.from({ length: 7 }, (_, i) => new Date(periodStart.getFullYear(), periodStart.getMonth(), periodStart.getDate() + i));
    labelsWithDates = weekDates.map(d => ({
      short: d.toLocaleDateString(undefined, { weekday: 'short' })[0],
      full: d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })
    }));
    dailyData = Array.from({ length: 7 }, () => ({ categories: {}, total: 0 }));

    periodReceipts.forEach(r => {
      const date = normalizeToLocalMidnight(r.date || r.transactionDate || r.createdAt);
      if (date) {
        // Calculate day index for Monday-Sunday week (0=Monday, 6=Sunday)
        const dayIndex = (date.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
        if (dayIndex >= 0 && dayIndex < 7) {
          const category = r.category || 'Uncategorized';
          const amount = parseFloat(r.total) || 0;
          dailyData[dayIndex].categories[category] = (dailyData[dayIndex].categories[category] || 0) + amount;
          dailyData[dayIndex].total += amount;
        }
      }
    });
  } else { // month
    const daysInMonth = periodEnd.getDate();
    labelsWithDates = Array.from({ length: daysInMonth }, (_, i) => {
      const d = new Date(periodStart.getFullYear(), periodStart.getMonth(), i + 1);
      return {
        short: (i + 1).toString(),
        full: d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })
      };
    });
    dailyData = Array.from({ length: daysInMonth }, () => ({ categories: {}, total: 0 }));

    periodReceipts.forEach(r => {
      const date = normalizeToLocalMidnight(r.date || r.transactionDate || r.createdAt);
      if (date) {
        const dayIndex = date.getDate() - 1;
        if (dayIndex >= 0 && dayIndex < daysInMonth) {
          const category = r.category || 'Uncategorized';
          const amount = parseFloat(r.total) || 0;
          dailyData[dayIndex].categories[category] = (dailyData[dayIndex].categories[category] || 0) + amount;
          dailyData[dayIndex].total += amount;
        }
      }
    });
  }
  
  const chartTotals = dailyData.map(d => d.total);
  const expenses = chartTotals.reduce((a, b) => a + b, 0);
  const spentPerDay = period === 'week' ? expenses / 7 : (chartTotals.length > 0 ? expenses / chartTotals.length : 0);
  
  const periodCategoryTotals = periodReceipts.reduce((acc, r) => {
    const cat = r.category || 'Uncategorized';
    const amt = parseFloat(r.total) || 0;
    acc[cat] = (acc[cat] || 0) + amt;
    return acc;
  }, {});
  
  const total = expenses;

  // Get all unique categories from the period
  const allCategories = [...new Set(Object.keys(periodCategoryTotals))];
  
  // Create stacked bar chart datasets
  const barDatasets = allCategories.map(category => {
    const categoryData = dailyData.map(dayData => dayData.categories[category] || 0);
    return {
      label: category,
      data: categoryData,
      backgroundColor: allCategoryColors[category] || '#9ca3af',
      borderRadius: 12,
      barPercentage: 0.6,
      categoryPercentage: 0.7,
      borderSkipped: false,
      stack: 'stack0', // This makes it a stacked bar
    };
  });

  // Bar chart data
  const barData = {
    labels: labelsWithDates.map(l => l.short),
    datasets: barDatasets,
  };
  
  // Bar chart options
  const barOptions = {
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        backgroundColor: '#1e293b',
        titleColor: '#f1f5f9',
        titleFont: { size: 14, weight: 'bold' },
        bodyColor: '#cbd5e1',
        bodyFont: { size: 12 },
        borderColor: 'rgba(99,102,241,0.5)',
        borderWidth: 1,
        displayColors: false,
        padding: 12,
        cornerRadius: 8,
        callbacks: {
          title: function(context) {
            if (!context[0]) return '';
            return labelsWithDates[context[0].dataIndex].full;
          },
          label: () => null,
          beforeBody: function(context) {
            const dataIndex = context[0].dataIndex;
            const dayData = dailyData[dataIndex];
            const sortedCategories = Object.entries(dayData.categories).sort((a, b) => b[1] - a[1]);
            if (sortedCategories.length === 0) return ['No expenses this day.'];
            return sortedCategories.map(([name, amount]) => `${name}: ${formatCurrency(amount, settings?.baseCurrency || 'EUR')}`);
          },
          footer: function(context) {
            const totalAmount = context[0].raw;
            if (totalAmount > 0) {
              return `\nTotal: ${formatCurrency(totalAmount, settings?.baseCurrency || 'EUR')}`;
            }
            return '';
          },
        },
      },
    },
    scales: {
      x: {
        grid: { drawBorder: false, color: 'rgba(226, 232, 240, 0.1)' },
        ticks: { color: '#94a3b8', font: { weight: '600' } },
      },
      y: {
        grid: { drawBorder: false, color: 'rgba(226, 232, 240, 0.1)' },
        ticks: { color: '#94a3b8' },
        beginAtZero: true,
        max: Math.max(60, Math.ceil(Math.max(...chartTotals) / 10) * 10),
      },
    },
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 800, easing: 'easeOutQuart' },
  };
  
  // Category legend with percentages
  const legend = Object.keys(periodCategoryTotals).map((cat, i) => {
    const percent = total ? ((periodCategoryTotals[cat] / total) * 100).toFixed(1) : 0;
    return { name: cat, color: allCategoryColors[cat] || '#9ca3af', percent };
  });
  
  return (
    <div className="w-full max-w-2xl mx-auto mt-2 mb-4 px-2">
      <div className="bg-white/90 text-gray-900 shadow-xl rounded-2xl border border-gray-200 p-6 flex flex-col items-center">
        {/* Header */}
        <div className="w-full flex flex-row items-center justify-between mb-2">
          <div className="text-lg font-bold">Expense Insights</div>
          <select
            className="bg-gray-100 rounded-lg px-2 py-1 text-sm font-semibold border border-gray-200 focus:outline-none"
            value={period}
            onChange={e => setPeriod(e.target.value)}
          >
            <option value="week">week</option>
            <option value="month">month</option>
          </select>
        </div>
        {/* Date range and stats */}
        <div className="w-full flex flex-row items-center justify-between mb-2 text-xs font-semibold text-gray-500">
          <span>{periodLabel}</span>
          <span>SPENT/DAY</span>
        </div>
        <div className="w-full flex flex-row items-center justify-between mb-4">
          <span className="text-2xl font-bold text-red-500">{formatCurrency(expenses, settings?.baseCurrency || 'EUR')}</span>
          <span className="text-2xl font-bold text-gray-900">{formatCurrency(spentPerDay, settings?.baseCurrency || 'EUR')}</span>
        </div>
        {/* Bar Chart */}
        <div className="w-full h-40 md:h-48 mb-2">
          <Bar data={barData} options={barOptions} />
        </div>
        {/* Category Legend */}
        <div className="flex flex-row flex-wrap items-center justify-center gap-4 mt-2 w-full">
          {legend.map(l => (
            <div key={l.name} className="flex items-center gap-2">
              <span className="inline-block w-6 h-3 rounded-full" style={{background: l.color}}></span>
              <span className="text-xs font-semibold text-gray-700">{l.name}</span>
              <span className="text-xs text-gray-400">{l.percent}%</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}